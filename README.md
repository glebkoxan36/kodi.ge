Полная инструкция по использованию тестового модуля

Тестовый модуль предоставляет эндпоинты для проверки ключевых функций системы. Для работы требуются права администратора (`admin` или `superadmin`).

---

#### 1. **Предварительные шаги**
- Убедитесь, что вы авторизованы как администратор (в сессии есть `role = admin/superadmin`)
- Все запросы отправляются на эндпоинты с префиксом `/test/`
- Для запросов используйте заголовок `Content-Type: application/json`

---

#### 2. **Тестовый пользователь**
Автоматически создаётся аккаунт с данными:
- **Email:** `test_admin@imei.ge`
- **Пароль:** `testpassword`
- **Баланс:** 1000 GEL (сбрасывается при каждом вызове тестов)

---

#### 3. **Эндпоинты**

##### a) Тестирование платной проверки IMEI  
**Endpoint:** `POST /test/paid-check`  
**Параметры (JSON):**
```json
{
  "imei": "012345678901234",
  "service_type": "fmi",
  "payment_method": "balance"
}
```
**Описание параметров:**
- `imei`: IMEI для проверки (по умолчанию: `012345678901234`)
- `service_type`: Тип услуги (`fmi`, `blacklist`, `activation`, `carrier`)
- `payment_method`: Способ оплаты (`balance` - с баланса, `stripe` - через Stripe)

**Пример ответа:**
```json
{
  "status": "success",
  "test_type": "paid_check",
  "payment_method": "balance",
  "service_type": "fmi",
  "amount": 0.5,
  "duration": "1.23s",
  "result": { ... }
}
```

---

##### b) Тестирование пополнения баланса  
**Endpoint:** `POST /test/topup`  
**Параметры (JSON):**
```json
{
  "amount": 10.0
}
```
**Описание:**
- `amount`: Сумма пополнения (в GEL)

**Пример ответа:**
```json
{
  "status": "success",
  "test_type": "balance_topup",
  "amount": 10.0,
  "new_balance": 1010.0
}
```

---

##### c) Тестирование возврата средств  
**Endpoint:** `POST /test/refund`  
**Параметры:** Не требуются  
**Описание:**  
Возвращает последнюю тестовую транзакцию пополнения.

**Пример ответа:**
```json
{
  "status": "success",
  "test_type": "refund",
  "refunded_amount": 10.0,
  "new_balance": 1000.0
}
```

---

##### d) Проверка статуса системы  
**Endpoint:** `GET /test/status`  
**Параметры:** Не требуются  

**Пример ответа:**
```json
{
  "status": "ok",
  "database": "ok",
  "stripe": "ok",
  "test_user": true
}
```

---

#### 4. **Примеры запросов (cURL)**

**Тест платной проверки (оплата с баланса):**
```bash
curl -X POST 'http://ваш-домен/test/paid-check' \
-H 'Content-Type: application/json' \
-d '{
  "imei": "012345678901234",
  "service_type": "fmi",
  "payment_method": "balance"
}' \
--cookie "session=<ваша_сессия>"
```

**Тест пополнения баланса:**
```bash
curl -X POST 'http://ваш-домен/test/topup' \
-H 'Content-Type: application/json' \
-d '{"amount": 5.5}' \
--cookie "session=<ваша_сессия>"
```

**Тест возврата средств:**
```bash
curl -X POST 'http://ваш-домен/test/refund' \
-H 'Content-Type: application/json' \
--cookie "session=<ваша_сессия>"
```

---

#### 5. **Важные замечания**
1. Все тестовые операции помечаются флагом `"is_test": true` в БД
2. Баланс тестового пользователя **всегда сбрасывается до 1000 GEL** при вызове любого теста
3. Для Stripe платежей:
   - Реальные транзакции **не создаются**
   - Платеж автоматически помечается как `"paid"`
   - Баланс пользователя увеличивается мгновенно
4. Логи тестов сохраняются в `logs/test_module.log`

---

#### 6. **Обработка ошибок**
При ошибках вы получите ответ в формате:
```json
{
  "status": "error",
  "message": "Описание ошибки"
}
```
Возможные коды ответов: `403` (нет прав), `404` (платеж не найден), `500` (серверная ошибка).

Используйте эти инструменты для проверки работоспособности платежной системы и API проверки IMEI перед запуском в продакшн.
