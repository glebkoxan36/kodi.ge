<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сравнение телефонов</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        /* Уникальные стили только для этой страницы */
        .phone-selector-btn {
            display: flex;
            align-items: center;
            padding: 15px 25px;
            background: rgba(255, 255, 255, 0.07);
            border: 1px solid rgba(0, 198, 255, 0.3);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 20px;
            text-align: left;
        }
        
        .phone-selector-btn:hover {
            background: rgba(0, 198, 255, 0.15);
            transform: translateY(-3px);
        }
        
        .phone-thumb-small {
            width: 60px;
            height: 60px;
            object-fit: contain;
            margin-right: 15px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .comparison-section {
            display: none;
            margin-top: 30px;
            animation: fadeIn 0.5s ease;
        }
        
        .winner-display {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin: 30px 0;
        }
        
        .phone-card {
            text-align: center;
            padding: 20px;
            border-radius: 15px;
            background: rgba(26, 36, 60, 0.8);
            width: 40%;
            transition: all 0.3s ease;
        }
        
        .winner {
            border: 3px solid var(--success-color);
            box-shadow: 0 0 20px rgba(0, 214, 143, 0.3);
        }
        
        .vs-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(0, 198, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-color);
        }
        
        .spec-group {
            margin-bottom: 25px;
        }
        
        .spec-header {
            background: rgba(0, 198, 255, 0.1);
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        
        .spec-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .spec-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 12px;
            border-radius: 8px;
        }
        
        .winner-value {
            color: var(--success-color);
            font-weight: bold;
        }
        
        .ai-analysis {
            background: rgba(26, 36, 60, 0.8);
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            position: relative;
        }
        
        .ai-icon {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 3rem;
            opacity: 0.1;
            color: var(--accent-color);
        }
    </style>
</head>
<body>
    <div class="main-content">
        <h1 class="section-title">Сравнение телефонов</h1>
        
        <div class="phone-selectors">
            <button id="selectPhone1Btn" class="phone-selector-btn">
                <div class="phone-info">
                    <img class="phone-thumb-small" id="phone1Thumb" src="/static/placeholder.jpg" alt="Телефон 1">
                    <div>
                        <div id="phone1Name">Выберите первый телефон</div>
                        <div class="text-secondary" id="phone1Details"></div>
                    </div>
                </div>
            </button>
            
            <button id="selectPhone2Btn" class="phone-selector-btn">
                <div class="phone-info">
                    <img class="phone-thumb-small" id="phone2Thumb" src="/static/placeholder.jpg" alt="Телефон 2">
                    <div>
                        <div id="phone2Name">Выберите второй телефон</div>
                        <div class="text-secondary" id="phone2Details"></div>
                    </div>
                </div>
            </button>
        </div>
        
        <div id="singlePhoneSpecs" class="comparison-section">
            <!-- Здесь будут отображаться характеристики одного телефона -->
        </div>
        
        <div id="comparisonResult" class="comparison-section">
            <div class="winner-display">
                <div id="phone1Card" class="phone-card">
                    <img id="winnerImage" class="phone-thumb" src="" alt="Победитель">
                    <h3 id="winnerName"></h3>
                    <div class="winner-percentage text-success"></div>
                </div>
                
                <div class="vs-circle">VS</div>
                
                <div id="phone2Card" class="phone-card">
                    <img id="loserImage" class="phone-thumb" src="" alt="Проигравший">
                    <h3 id="loserName"></h3>
                    <div class="loser-percentage"></div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3>Ключевые преимущества</h3>
                </div>
                <div class="card-body" id="winnerReason"></div>
            </div>
            
            <button id="showFullSpecsBtn" class="btn-primary">Показать все характеристики</button>
            
            <div id="fullSpecs" style="display: none; margin-top: 20px;">
                <!-- Здесь будут все характеристики -->
            </div>
            
            <div class="ai-analysis card">
                <div class="card-header">
                    <h3>Анализ ИИ</h3>
                </div>
                <div class="card-body" id="aiAnalysisText"></div>
                <div class="ai-icon">AI</div>
            </div>
        </div>
    </div>

    <!-- Модальное окно поиска телефонов -->
    <div id="phoneSearchModal" class="result-modal">
        <div class="modal-content">
            <div class="card-header">
                <h2 id="modalTitle">Поиск телефонов</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <input type="text" id="phoneSearchInput" class="form-control" placeholder="Поиск по бренду или модели...">
                </div>
                <div id="searchResults"></div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            let selectedTarget = null;
            let phone1 = null;
            let phone2 = null;
            
            // Открытие модального окна
            $('#selectPhone1Btn, #selectPhone2Btn').click(function() {
                selectedTarget = $(this).attr('id').replace('Btn', '');
                $('#modalTitle').text('Выберите телефон для ' + (selectedTarget === 'selectPhone1' ? 'первого' : 'второго'));
                $('#phoneSearchModal').show();
                $('#phoneSearchInput').focus();
            });
            
            // Закрытие модального окна
            $('.close-modal').click(function() {
                $('#phoneSearchModal').hide();
            });
            
            // Поиск телефонов
            $('#phoneSearchInput').keyup(function() {
                const query = $(this).val();
                if (query.length < 2) {
                    $('#searchResults').html('');
                    return;
                }
                
                $.get('/api/search_phones', { query: query }, function(data) {
                    let html = '';
                    data.forEach(phone => {
                        html += `
                            <div class="phone-search-result" data-id="${phone._id}">
                                <div class="phone-info">
                                    <img src="${phone.image_url}" class="phone-thumb-small">
                                    <div>
                                        <div>${phone.brand} ${phone.model}</div>
                                        <div class="text-secondary">${phone.release_year}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    $('#searchResults').html(html || '<p>Телефоны не найдены</p>');
                    
                    // Обработка выбора телефона
                    $('.phone-search-result').click(function() {
                        const phoneId = $(this).data('id');
                        selectPhone(phoneId);
                    });
                });
            });
            
            // Выбор телефона
            function selectPhone(phoneId) {
                $.get('/api/search_phones', { id: phoneId }, function(phone) {
                    if (selectedTarget === 'selectPhone1') {
                        phone1 = phone;
                        updatePhoneDisplay(phone, '#phone1Thumb', '#phone1Name', '#phone1Details');
                    } else {
                        phone2 = phone;
                        updatePhoneDisplay(phone, '#phone2Thumb', '#phone2Name', '#phone2Details');
                    }
                    
                    $('#phoneSearchModal').hide();
                    checkComparisonState();
                });
            }
            
            // Обновление отображения телефона
            function updatePhoneDisplay(phone, thumbSelector, nameSelector, detailsSelector) {
                $(thumbSelector).attr('src', phone.image_url || '/static/placeholder.jpg');
                $(nameSelector).text(`${phone.brand} ${phone.model}`);
                $(detailsSelector).text(phone.release_year ? `Выпуск: ${phone.release_year}` : '');
            }
            
            // Проверка состояния выбора
            function checkComparisonState() {
                if (phone1 && !phone2) {
                    showSinglePhoneSpecs(phone1);
                } else if (phone1 && phone2) {
                    comparePhones();
                } else {
                    hideAllSections();
                }
            }
            
            // Показ характеристик одного телефона
            function showSinglePhoneSpecs(phone) {
                $('#singlePhoneSpecs').show().html(`
                    <div class="card">
                        <div class="card-header">
                            <h3>Характеристики ${phone.brand} ${phone.model}</h3>
                        </div>
                        <div class="card-body">
                            <img src="${phone.image_url}" class="phone-thumb" style="max-width: 200px; margin: 0 auto 20px; display: block;">
                            <!-- Здесь будут характеристики -->
                        </div>
                    </div>
                `);
                $('#comparisonResult').hide();
            }
            
            // Сравнение телефонов
            function comparePhones() {
                $.post('/api/compare', {
                    phone1_id: phone1._id,
                    phone2_id: phone2._id
                }, function(result) {
                    displayComparisonResult(result);
                });
            }
            
            // Отображение результатов сравнения
            function displayComparisonResult(result) {
                // Определяем победителя
                const winner = result.overall_winner === 'phone1' ? result.phone1 : result.phone2;
                const loser = result.overall_winner === 'phone1' ? result.phone2 : result.phone1;
                
                // Обновляем отображение
                $('#winnerImage').attr('src', winner.image_url || '/static/placeholder.jpg');
                $('#winnerName').text(`${winner.Бренд} ${winner.Модель}`);
                $('.winner-percentage').text(`${result.percent_${result.overall_winner}}%`);
                
                $('#loserImage').attr('src', loser.image_url || '/static/placeholder.jpg');
                $('#loserName').text(`${loser.Бренд} ${loser.Модель}`);
                $('.loser-percentage').text(`${result.percent_${result.overall_winner === 'phone1' ? 'phone2' : 'phone1'}}%`);
                
                // Добавляем класс победителю
                $(`#${result.overall_winner}Card`).addClass('winner');
                
                // Ключевые преимущества
                let advantagesHtml = '';
                result.comparison.forEach(category => {
                    if (category.category_percent_phone1 !== category.category_percent_phone2) {
                        const winnerPercent = Math.max(category.category_percent_phone1, category.category_percent_phone2);
                        const winnerPhone = category.category_percent_phone1 > category.category_percent_phone2 ? 
                                            result.phone1.Модель : result.phone2.Модель;
                        
                        advantagesHtml += `
                            <div class="advantage-item">
                                <strong>${category.category}:</strong>
                                ${winnerPhone} (${winnerPercent}% vs ${Math.min(category.category_percent_phone1, category.category_percent_phone2)}%)
                            </div>
                        `;
                    }
                });
                $('#winnerReason').html(advantagesHtml);
                
                // Полные характеристики
                let fullSpecsHtml = '';
                result.comparison.forEach(category => {
                    fullSpecsHtml += `
                        <div class="spec-group">
                            <div class="spec-header">
                                <h4>${category.category}</h4>
                            </div>
                            <div class="spec-content">
                    `;
                    
                    category.specs.forEach(spec => {
                        const isPhone1Winner = spec.winner === 'phone1';
                        const isPhone2Winner = spec.winner === 'phone2';
                        
                        fullSpecsHtml += `
                            <div class="spec-item">
                                <div class="spec-name">${spec.name}</div>
                                <div class="spec-values">
                                    <div class="${isPhone1Winner ? 'winner-value' : ''}">
                                        ${spec.phone1_value}
                                    </div>
                                    <div class="${isPhone2Winner ? 'winner-value' : ''}">
                                        ${spec.phone2_value}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    fullSpecsHtml += `
                            </div>
                        </div>
                    `;
                });
                $('#fullSpecs').html(fullSpecsHtml);
                
                // Анализ ИИ
                $('#aiAnalysisText').text(result.ai_analysis || "Анализ ИИ временно недоступен");
                
                // Показываем секции
                $('#singlePhoneSpecs').hide();
                $('#comparisonResult').show();
            }
            
            // Скрытие всех секций
            function hideAllSections() {
                $('#singlePhoneSpecs').hide();
                $('#comparisonResult').hide();
            }
            
            // Кнопка показа всех характеристик
            $('#showFullSpecsBtn').click(function() {
                $('#fullSpecs').slideToggle();
            });
        });
    </script>
</body>
</html>
