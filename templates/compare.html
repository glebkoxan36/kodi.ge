<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ტელეფონების შედარება</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
            
</head>
<body>
    <div class="main-content">
        <h1 class="section-title">ტელეფონების შედარება</h1>
        
        <!-- Выбор режима работы -->
        <div class="mode-selection">
            <button id="singleModeBtn" class="mode-btn">
                <div class="mode-icon">📱</div>
                <div class="mode-title">ტელეფონის მახასიათებლების ნახვა</div>
            </button>
            <button id="compareModeBtn" class="mode-btn">
                <div class="mode-icon">🔄</div>
                <div class="mode-title">ორი ტელეფონის შედარება</div>
            </button>
        </div>
        
        <!-- Режим просмотра характеристик одного телефона -->
        <div id="singlePhoneModeContainer" style="display: none;">
            <div class="phone-selectors">
                <button id="selectSinglePhoneBtn" class="phone-selector-btn">
                    <div class="phone-thumb-container">
                        <div class="add-icon">+</div>
                    </div>
                    <div class="phone-info-text">
                        <div class="phone-title">აირჩიეთ ტელეფონი</div>
                        <div class="phone-subtitle">დააწკაპუნეთ მახასიათებლების სანახავად</div>
                    </div>
                </button>
            </div>
            
            <div id="singlePhoneSpecs" class="comparison-section"></div>
        </div>
        
        <!-- Режим сравнения двух телефонов -->
        <div id="compareModeContainer" style="display: none;">
            <div class="phone-selectors">
                <button id="selectPhone1Btn" class="phone-selector-btn">
                    <div class="phone-thumb-container">
                        <div class="add-icon">+</div>
                    </div>
                    <div class="phone-info-text">
                        <div class="phone-title">აირჩიეთ პირველი ტელეფონი</div>
                        <div class="phone-subtitle">დააწკაპუნეთ შესადარებლად დასამატებლად</div>
                    </div>
                </button>
                
                <div id="afterFirstSelected" style="display: none;">
                    <div id="secondSelectorContainer" class="second-selector-container">
                        <button id="selectPhone2Btn" class="phone-selector-btn">
                            <div class="phone-thumb-container">
                                <div class="add-icon">+</div>
                            </div>
                            <div class="phone-info-text">
                                <div class="phone-title">აირჩიეთ მეორე ტელეფონი</div>
                                <div class="phone-subtitle">დააწკაპუნეთ შესადარებლად დასამატებლად</div>
                            </div>
                        </button>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button id="startComparisonBtn" class="btn-primary start-comparison-btn">
                        შედარების დაწყება
                    </button>
                </div>
            </div>
            
            <div id="comparisonResult" class="comparison-section">
                <div class="winner-display">
                    <div id="phone1Card" class="phone-card">
                        <img id="winnerImage" class="phone-thumb" src="" alt="გამარჯვებული">
                        <h3 id="winnerName"></h3>
                        <div class="phone-percentage winner-percentage"></div>
                    </div>
                    
                    <div class="vs-circle">VS</div>
                    
                    <div id="phone2Card" class="phone-card">
                        <img id="loserImage" class="phone-thumb" src="" alt="დამარცხებული">
                        <h3 id="loserName"></h3>
                        <div class="phone-percentage loser-percentage"></div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3>ძირითადი უპირატესობები</h3>
                    </div>
                    <div class="card-body" id="winnerReason"></div>
                </div>
                
                <button id="showFullSpecsBtn" class="btn-primary">ყველა მახასიათებლის ჩვენება</button>
                
                <div id="fullSpecs">
                    <!-- ყველა მახასიათებელი -->
                </div>
                
                <div class="ai-analysis card">
                    <div class="card-header">
                        <h3>AI ანალიზი</h3>
                    </div>
                    <div class="card-body" id="aiAnalysisText"></div>
                    <div class="ai-icon">AI</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно поиска телефонов -->
    <div id="phoneSearchModal" class="result-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ტელეფონების ძებნა</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <input type="text" id="phoneSearchInput" class="form-control" placeholder="ძებნა ბრენდის ან მოდელის მიხედვით...">
                </div>
                <div id="searchResults"></div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            let selectedTarget = null;
            let phone1 = null;
            let phone2 = null;
            let singlePhone = null;
            
            // Вспомогательные функции для получения данных
            function getBrand(phone) {
                return phone.brand || phone.Бренд || phone['Бренд'] || 'Unknown brand';
            }
            
            function getModel(phone) {
                return phone.model || phone.Модель || phone['Модель'] || 'Unknown model';
            }
            
            function getReleaseYear(phone) {
                return phone.release_year || phone['Год выпуска'] || 'არ არის მითითებული';
            }
            
            function getImageUrl(phone) {
                return phone.image_url || phone.image || '/static/placeholder.jpg';
            }
            
            // Функция для получения CSRF токена из cookies
            function getCSRFToken() {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [name, value] = cookie.trim().split('=');
                    if (name === 'csrf_token') {
                        return decodeURIComponent(value);
                    }
                }
                return null;
            }
            
            // Настройка AJAX для отправки CSRF токена
            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type)) {
                        const csrfToken = getCSRFToken();
                        if (csrfToken) {
                            xhr.setRequestHeader('X-CSRFToken', csrfToken);
                        }
                    }
                }
            });
            
            // Регистрация обработчиков событий
            function setupEventHandlers() {
                // Обработчики для кнопок режимов
                $('#singleModeBtn').on('click', function() {
                    $('.mode-selection').hide();
                    $('#singlePhoneModeContainer').show();
                    $('#compareModeContainer').hide();
                    resetComparisonState();
                });
                
                $('#compareModeBtn').on('click', function() {
                    $('.mode-selection').hide();
                    $('#compareModeContainer').show();
                    $('#singlePhoneModeContainer').hide();
                    resetComparisonState();
                });
                
                // Обработчики для кнопок выбора телефонов
                $('#selectSinglePhoneBtn, #selectPhone1Btn, #selectPhone2Btn').on('click', handlePhoneSelectorClick);
                $('.close-modal').on('click', closeModal);
                $('#showFullSpecsBtn').on('click', toggleFullSpecs);
                $('#startComparisonBtn').on('click', comparePhones);
                
                // Обработчики для динамических элементов
                $(document).on('click', '.retry-btn', handleRetryClick);
                $(document).on('click', '.phone-search-result', handleSearchResultClick);
                $(document).on('click', '#retryComparisonBtn', handleRetryComparison);
                $(document).on('click', '#phoneSearchModal', handleModalBackgroundClick);
                
                // Обработка ввода в поле поиска
                $('#phoneSearchInput').on('keyup', handleSearchInput);
            }
            
            function resetComparisonState() {
                phone1 = null;
                phone2 = null;
                singlePhone = null;
                
                // Сбросить UI
                $('#selectPhone1Btn').html(`
                    <div class="phone-thumb-container">
                        <div class="add-icon">+</div>
                    </div>
                    <div class="phone-info-text">
                        <div class="phone-title">აირჩიეთ პირველი ტელეფონი</div>
                        <div class="phone-subtitle">დააწკაპუნეთ შესადარებლად დასამატებლად</div>
                    </div>
                `);
                
                $('#selectPhone2Btn').html(`
                    <div class="phone-thumb-container">
                        <div class="add-icon">+</div>
                    </div>
                    <div class="phone-info-text">
                        <div class="phone-title">აირჩიეთ მეორე ტელეფონი</div>
                        <div class="phone-subtitle">დააწკაპუნეთ შესადარებლად დასამატებლად</div>
                    </div>
                `);
                
                $('#afterFirstSelected').hide();
                $('#startComparisonBtn').hide();
                $('#comparisonResult').hide();
            }
            
            // Обработчики событий
            function handlePhoneSelectorClick() {
                selectedTarget = $(this).attr('id').replace('Btn', '');
                let modeText = '';
                
                if (selectedTarget === 'selectSinglePhone') {
                    modeText = 'ტელეფონის';
                } else if (selectedTarget === 'selectPhone1') {
                    modeText = 'პირველი';
                } else {
                    modeText = 'მეორე';
                }
                
                $('.modal-title').text('აირჩიეთ ' + modeText + ' ტელეფონი');
                $('#phoneSearchModal').css('display', 'flex');
                $('#phoneSearchInput').val('').focus();
                $('#searchResults').html('');
            }
            
            function closeModal() {
                $('#phoneSearchModal').hide();
            }
            
            function handleModalBackgroundClick(event) {
                if ($(event.target).hasClass('result-modal')) {
                    $('#phoneSearchModal').hide();
                }
            }
            
            function handleSearchInput() {
                const query = $(this).val();
                if (query.length < 2) {
                    $('#searchResults').html('');
                    return;
                }
                
                // Показываем индикатор загрузки
                $('#searchResults').html(`
                    <div style="text-align: center; padding: 30px;">
                        <div class="loading-spinner"></div>
                        <p style="margin-top: 15px;">მიმდინარეობს ძებნა...</p>
                    </div>
                `);
                
                // Запрос к API для поиска телефонов
                $.ajax({
                    url: '/api/search_phones',
                    type: 'GET',
                    data: { query: query },
                    success: function(data) {
                        renderSearchResults(data);
                    },
                    error: renderSearchError
                });
            }
            
            function handleSearchResultClick() {
                const phoneId = $(this).data('id');
                selectPhone(phoneId);
            }
            
            function handleRetryClick() {
                const target = $(this).data('target');
                retryLoadPhone(target);
            }
            
            function handleRetryComparison() {
                comparePhones();
            }
            
            function toggleFullSpecs() {
                $('#fullSpecs').slideToggle();
                $(this).text(function(i, text) {
                    return text === "ყველა მახასიათებლის ჩვენება" 
                           ? "მახასიათებლების დამალვა" 
                           : "ყველა მახასიათებლის ჩვენება";
                });
            }
            
            // Вспомогательные функции
            function renderSearchResults(data) {
                let html = '';
                if (data.length > 0) {
                    data.forEach(phone => {
                        const brand = getBrand(phone);
                        const model = getModel(phone);
                        const releaseYear = getReleaseYear(phone);
                        
                        html += `
                            <div class="phone-search-result" data-id="${phone._id}">
                                <img src="${getImageUrl(phone)}" alt="${brand} ${model}">
                                <div class="phone-search-info">
                                    <div class="phone-search-name">${brand} ${model}</div>
                                    <div class="phone-search-details">გამოშვების წელი: ${releaseYear}</div>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html = '<div class="phone-search-result" style="justify-content: center; padding: 30px;">ტელეფონები ვერ მოიძებნა</div>';
                }
                $('#searchResults').html(html);
            }
            
            function renderSearchError() {
                $('#searchResults').html(`
                    <div class="error-message">
                        ძებნის პროცესში მოხდა შეცდომა
                        <button class="retry-btn search-retry-btn">ხელახლა ცდა</button>
                    </div>
                `);
            }
            
            function selectPhone(phoneId) {
                showLoading(selectedTarget);
                
                // Запрос деталей телефона
                $.ajax({
                    url: '/api/phone_details',
                    type: 'GET',
                    data: { id: phoneId },
                    success: function(phone) {
                        updatePhoneSelection(phone);
                        $('#phoneSearchModal').hide();
                        
                        // Для одиночного режима сразу показываем характеристики
                        if (selectedTarget === 'selectSinglePhone') {
                            showSinglePhoneSpecs(phone);
                        }
                    },
                    error: function() {
                        showError(selectedTarget, 'ტელეფონის ინფორმაციის ჩატვირთვა ვერ მოხერხდა');
                    }
                });
            }
            
            function updatePhoneSelection(phone) {
                if (selectedTarget === 'selectSinglePhone') {
                    singlePhone = phone;
                    updatePhoneDisplay(phone, '#selectSinglePhoneBtn');
                } 
                else if (selectedTarget === 'selectPhone1') {
                    phone1 = phone;
                    updatePhoneDisplay(phone, '#selectPhone1Btn');
                    showAfterFirstSelected();
                } else {
                    phone2 = phone;
                    updatePhoneDisplay(phone, '#selectPhone2Btn');
                    showComparisonButton();
                }
            }
            
            function showLoading(target) {
                const btnSelector = `#${target}Btn`;
                $(btnSelector).html(`
                    <div class="phone-thumb-container">
                        <div class="loading-spinner"></div>
                    </div>
                    <div class="phone-info-text">
                        <div class="phone-title">იტვირთება...</div>
                        <div class="phone-subtitle">გთხოვთ დაიცადოთ</div>
                    </div>
                `);
            }
            
            function showError(target, message) {
                const btnSelector = `#${target}Btn`;
                $(btnSelector).html(`
                    <div class="phone-thumb-container">
                        <div style="font-size: 1.5rem; color: var(--error-color);">!</div>
                    </div>
                    <div class="phone-info-text">
                        <div class="phone-title" style="color: var(--error-color);">შეცდომა</div>
                        <div class="phone-subtitle">${message}</div>
                        <button class="retry-btn" data-target="${target}">ხელახლა ცდა</button>
                    </div>
                `);
            }
            
            function updatePhoneDisplay(phone, btnSelector) {
                const brand = getBrand(phone);
                const model = getModel(phone);
                const releaseYear = getReleaseYear(phone);
                const imageUrl = getImageUrl(phone);
                
                $(btnSelector).html(`
                    <div class="phone-thumb-container">
                        <img src="${imageUrl}" alt="${brand} ${model}" style="max-width: 100%; max-height: 100%;">
                    </div>
                    <div class="phone-info-text">
                        <div class="phone-title">${brand} ${model}</div>
                        <div class="phone-subtitle">გამოშვების წელი: ${releaseYear}</div>
                    </div>
                `);
                
                $(btnSelector).css({
                    transform: 'scale(0.95)',
                    border: '2px solid rgba(0, 198, 255, 0.5)'
                });
                
                setTimeout(function() {
                    $(btnSelector).css({
                        transform: 'scale(1)',
                        border: '1px solid rgba(0, 198, 255, 0.3)'
                    });
                }, 300);
            }
            
            function showAfterFirstSelected() {
                $('#afterFirstSelected').show();
                $('#secondSelectorContainer').show();
                $('#startComparisonBtn').hide();
            }
            
            function showComparisonButton() {
                $('#afterFirstSelected').show(); // Исправлено: не скрываем контейнер
                $('#startComparisonBtn').show();
            }
            
            // Показать характеристики одного телефона
            function showSinglePhoneSpecs(phone) {
                const brand = getBrand(phone);
                const model = getModel(phone);
                const imageUrl = getImageUrl(phone);
                
                // Фильтруем технические характеристики
                const technicalSpecs = Object.entries(phone)
                    .filter(([key]) => !['_id', 'image_url', 'image', 'brand', 'model', 'release_year', 'Бренд', 'Модель', 'Год выпуска'].includes(key))
                    .map(([key, value]) => ({
                        key: key,
                        value: value || '-'
                    }));
                
                $('#singlePhoneSpecs').show().html(`
                    <div class="card">
                        <div class="card-header">
                            <h3>${brand} ${model} - მახასიათებლები</h3>
                        </div>
                        <div class="card-body">
                            <img src="${imageUrl}" 
                                 class="phone-thumb" 
                                 style="margin: 0 auto 30px; display: block;">
                            <div class="specs-container">
                                <table class="specs-table">
                                    <thead>
                                        <tr>
                                            <th>მახასიათებელი</th>
                                            <th>მნიშვნელობა</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${technicalSpecs.map(spec => `
                                            <tr>
                                                <td>${spec.key}</td>
                                                <td>${spec.value}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `);
                
                $('#comparisonResult').hide();
            }
            
            function comparePhones() {
                if (!phone1 || !phone2) {
                    showErrorNotification('გთხოვთ აირჩიოთ ორივე ტელეფონი შედარებისთვის');
                    return;
                }
                
                $('#comparisonResult').html(`
                    <div style="text-align: center; padding: 50px;">
                        <div class="loading-spinner" style="width: 50px; height: 50px;"></div>
                        <p style="margin-top: 20px; font-size: 1.2rem;">მიმდინარეობს შედარება...</p>
                    </div>
                `).show();
                
                // Исправление: правильное извлечение ID
                const getPhoneId = (phone) => {
                    if (phone._id && phone._id.$oid) {
                        return phone._id.$oid;
                    }
                    return phone._id;
                };
                
                const phone1Id = getPhoneId(phone1);
                const phone2Id = getPhoneId(phone2);
                
                // Исправление: правильный формат данных для сервера
                $.ajax({
                    url: '/api/compare',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        phone1_id: phone1Id,
                        phone2_id: phone2Id
                    }),
                    success: function(result) {
                        displayComparisonResult(result);
                    },
                    error: function(xhr) {
                        let errorMsg = `შედარების პროცესი ვერ მოხერხდა (${xhr.status} ${xhr.statusText})`;
                        try {
                            const response = JSON.parse(xhr.responseText);
                            if (response.error) {
                                errorMsg = response.error;
                            } else if (response.message) {
                                errorMsg = response.message;
                            }
                        } catch (e) {
                            errorMsg = xhr.responseText || errorMsg;
                        }
                        console.error("Comparison error:", errorMsg, xhr);
                        $('#comparisonResult').html(`
                            <div class="error-message" style="margin: 30px;">
                                ${errorMsg}
                                <button class="retry-btn" id="retryComparisonBtn">ხელახლა ცდა</button>
                            </div>
                        `);
                    }
                });
                
                $('#singlePhoneSpecs').hide();
            }
            
            function displayComparisonResult(result) {
                // Проверка наличия необходимых данных
                if (!result || !result.phone1 || !result.phone2) {
                    $('#comparisonResult').html(`
                        <div class="error-message" style="margin: 30px;">
                            შედარების შედეგები არასწორია
                            <button class="retry-btn" id="retryComparisonBtn">ხელახლა ცდა</button>
                        </div>
                    `);
                    return;
                }
                
                const brand1 = getBrand(result.phone1);
                const model1 = getModel(result.phone1);
                const brand2 = getBrand(result.phone2);
                const model2 = getModel(result.phone2);
                
                const winner = result.overall_winner === 'phone1' ? result.phone1 : result.phone2;
                const loser = result.overall_winner === 'phone1' ? result.phone2 : result.phone1;
                
                const winnerBrand = getBrand(winner);
                const winnerModel = getModel(winner);
                const loserBrand = getBrand(loser);
                const loserModel = getModel(loser);
                
                $('#winnerImage').attr('src', getImageUrl(winner));
                $('#winnerName').text(`${winnerBrand} ${winnerModel}`);
                $('.winner-percentage').text(`${result.percent_phone1}%`);
                
                $('#loserImage').attr('src', getImageUrl(loser));
                $('#loserName').text(`${loserBrand} ${loserModel}`);
                $('.loser-percentage').text(`${result.percent_phone2}%`);
                
                $(`#phone1Card`).toggleClass('winner', result.overall_winner === 'phone1');
                $(`#phone2Card`).toggleClass('winner', result.overall_winner === 'phone2');
                
                // Отображение преимуществ
                let advantagesHtml = '';
                if (result.comparison && result.comparison.length > 0) {
                    result.comparison.forEach(category => {
                        if (category.category_percent_phone1 !== category.category_percent_phone2) {
                            const winnerPercent = Math.max(category.category_percent_phone1, category.category_percent_phone2);
                            const loserPercent = Math.min(category.category_percent_phone1, category.category_percent_phone2);
                            const winnerPhone = category.category_percent_phone1 > category.category_percent_phone2 ? 
                                                model1 : model2;
                            
                            advantagesHtml += `
                                <div class="advantage-item">
                                    <div class="advantage-header">
                                        <strong>${category.category}</strong>
                                        <span style="color: var(--success-color);">${winnerPercent}%</span>
                                    </div>
                                    <div class="advantage-details">
                                        <span>${winnerPhone} უკეთესია ${(winnerPercent - loserPercent).toFixed(1)}%-ით</span>
                                        <span>${loserPercent}%</span>
                                    </div>
                                </div>
                            `;
                        }
                    });
                }
                
                $('#winnerReason').html(advantagesHtml || '<p>უპირატესობები არ მოიძებნა</p>');
                
                // Отображение всех характеристик
                let fullSpecsHtml = '';
                if (result.comparison && result.comparison.length > 0) {
                    result.comparison.forEach(category => {
                        fullSpecsHtml += `
                            <div class="spec-group">
                                <div class="card-header">
                                    <h4>${category.category}</h4>
                                </div>
                                <div class="card-body">
                                    <div class="specs-container">
                                        <table class="specs-table">
                                            <thead>
                                                <tr>
                                                    <th style="width: 30%;">მახასიათებელი</th>
                                                    <th style="width: 35%;">${brand1}</th>
                                                    <th style="width: 35%;">${brand2}</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                        `;
                        
                        if (category.specs && category.specs.length > 0) {
                            category.specs.forEach(spec => {
                                const isPhone1Winner = spec.winner === 'phone1';
                                const isPhone2Winner = spec.winner === 'phone2';
                                
                                fullSpecsHtml += `
                                    <tr>
                                        <td>${spec.name}</td>
                                        <td class="${isPhone1Winner ? 'winner-value' : ''}">${spec.phone1_value || '-'}</td>
                                        <td class="${isPhone2Winner ? 'winner-value' : ''}">${spec.phone2_value || '-'}</td>
                                    </tr>
                                `;
                            });
                        } else {
                            fullSpecsHtml += `
                                <tr>
                                    <td colspan="3" style="text-align: center; color: var(--text-secondary);">მახასიათებლები არ მოიძებნა</td>
                                </tr>
                            `;
                        }
                        
                        fullSpecsHtml += `
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    fullSpecsHtml = '<div class="error-message">შედარების მონაცემები ვერ მოიძებნა</div>';
                }
                
                $('#fullSpecs').html(fullSpecsHtml);
                
                // AI анализ
                $('#aiAnalysisText').html(result.ai_analysis || "<p>AI ანალიზი ხელმიუწვდომელია</p>");
                
                $('#singlePhoneSpecs').hide();
                $('#comparisonResult').show();
            }
            
            function retryLoadPhone(target) {
                const phoneId = target === 'selectPhone1' ? (phone1 && phone1._id) : (phone2 && phone2._id);
                if (phoneId) {
                    $(`#${target}Btn`).html(`
                        <div class="phone-thumb-container">
                            <div class="loading-spinner"></div>
                        </div>
                        <div class="phone-info-text">
                            <div class="phone-title">იტვირთება...</div>
                            <div class="phone-subtitle">გთხოვთ დაიცადოთ</div>
                        </div>
                    `);
                    
                    $.ajax({
                        url: '/api/phone_details',
                        type: 'GET',
                        data: { id: phoneId },
                        success: function(phone) {
                            updatePhoneSelection(phone);
                        },
                        error: function() {
                            showError(target, 'ტელეფონის ინფორმაციის ჩატვირთვა ვერ მოხერხდა');
                        }
                    });
                } else {
                    $(`#${target}Btn`).click();
                }
            }
            
            function showErrorNotification(message) {
                const notification = $(`
                    <div class="notification error-notification">
                        ${message}
                    </div>
                `);
                
                $('body').append(notification);
                
                setTimeout(() => {
                    notification.fadeOut(500, () => notification.remove());
                }, 5000);
            }
            
            // Инициализация обработчиков событий
            setupEventHandlers();
        });
    </script>
</body>
    </html>
