<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kodi.ge - ტელეფონების შედარება</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="gradient-bg gradient-1"></div>
    <div class="gradient-bg gradient-2"></div>
    
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-logo">
            <div class="logo-animated">
                <div class="logo-ring"></div>
                <div class="logo-ring"></div>
                <div class="logo-ring"></div>
                <div class="logo-core">
                    <div class="logo-letter">K</div>
                </div>
            </div>
            <h2>KODI.GE</h2>
        </div>
        
        <div class="user-profile-section">
            <div class="user-avatar-container">
                <img src="/static/avatar-placeholder.png" alt="User Avatar" class="user-avatar">
            </div>
            <div class="user-name">მომხმარებელი</div>
        </div>
        
        <nav class="nav flex-column">
            <a href="#" class="nav-link">
                <i class="fas fa-home"></i>
                <span>მთავარი</span>
            </a>
            <a href="#" class="nav-link">
                <i class="fas fa-mobile-alt"></i>
                <span>ტელეფონები</span>
            </a>
            <a href="#" class="nav-link active">
                <i class="fas fa-exchange-alt"></i>
                <span>შედარება</span>
            </a>
            <a href="#" class="nav-link">
                <i class="fas fa-history"></i>
                <span>ისტორია</span>
            </a>
            <a href="#" class="nav-link">
                <i class="fas fa-cog"></i>
                <span>პარამეტრები</span>
            </a>
            <a href="#" class="nav-link">
                <i class="fas fa-sign-out-alt"></i>
                <span>გამოსვლა</span>
            </a>
        </nav>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <div class="compare-container py-5">
            <!-- Header -->
            <div class="text-center mb-5">
                <h1 class="section-title">ტელეფონების შედარება</h1>
                <p class="lead">შეადარეთ ნებისმიერი ორი მოწყობილობა და გაიგეთ რომელია თქვენთვის საუკეთესო</p>
            </div>
            
            <!-- Comparison Section -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-exchange-alt me-2"></i>
                    ტელეფონების შედარება
                </div>
                <div class="card-body">
                    <div class="compare-search-container">
                        <div class="row">
                            <div class="col-md-6 position-relative mb-3">
                                <input type="text" class="compare-search-input" id="phone1Search" placeholder="მოძებნეთ პირველი ტელეფონი...">
                                <div id="suggestions1" class="compare-suggestions-dropdown"></div>
                            </div>
                            <div class="col-md-6 position-relative">
                                <input type="text" class="compare-search-input" id="phone2Search" placeholder="მოძებნეთ მეორე ტელეფონი...">
                                <div id="suggestions2" class="compare-suggestions-dropdown"></div>
                            </div>
                        </div>
                        
                        <button id="compareButton" class="compare-btn" disabled>
                            <i class="fas fa-exchange-alt me-2"></i>შედარების დაწყება
                        </button>
                    </div>
                    
                    <!-- COMPARISON GRID CONTAINER -->
                    <div class="comparison-grid-container" id="comparisonGrid">
                        <div class="specs-grid">
                            <!-- Header row -->
                            <div class="grid-header phone-header">
                                <img src="/static/phone-placeholder.png" class="phone-thumb" id="phone1Thumb" alt="Phone 1" onerror="handleImageError(event)">
                                <span id="phone1Title"></span>
                            </div>
                            
                            <div class="divider-cell">
                                <div class="divider-line"></div>
                            </div>
                            
                            <div class="grid-header phone-header">
                                <img src="/static/phone-placeholder.png" class="phone-thumb" id="phone2Thumb" alt="Phone 2" onerror="handleImageError(event)">
                                <span id="phone2Title"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="compare-ai-analysis" id="aiAnalysis" style="display: none;">
                        <div class="compare-ai-header">
                            <i class="fas fa-robot compare-ai-icon"></i>
                            <h3>Kodi.ge AI შედარება</h3>
                        </div>
                        <div class="compare-ai-content" id="aiContent"></div>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <footer class="mt-5 pt-4 border-top border-secondary text-center">
                <p>© 2023 Kodi.ge. ყველა უფლება დაცულია.</p>
            </footer>
        </div>
    </div>
    
    <script>
        // Function to handle image loading errors
        function handleImageError(event) {
            event.target.onerror = null;
            event.target.src = '/static/placeholder.jpg';
        }
        
        // Phone selection state
        let selectedPhone1 = null;
        let selectedPhone2 = null;
        
        // DOM elements
        const phone1Search = document.getElementById('phone1Search');
        const phone2Search = document.getElementById('phone2Search');
        const suggestions1 = document.getElementById('suggestions1');
        const suggestions2 = document.getElementById('suggestions2');
        const compareButton = document.getElementById('compareButton');
        const comparisonGrid = document.getElementById('comparisonGrid');
        const specsGrid = document.querySelector('.specs-grid');
        const aiAnalysis = document.getElementById('aiAnalysis');
        const aiContent = document.getElementById('aiContent');
        const apiError = document.getElementById('apiError');
        const phone1Thumb = document.getElementById('phone1Thumb');
        const phone2Thumb = document.getElementById('phone2Thumb');
        const phone1Title = document.getElementById('phone1Title');
        const phone2Title = document.getElementById('phone2Title');
        
        // Rules for numeric comparisons
        const numericComparisonRules = {
            'Battery_capacity': 'higher',
            'Memory_internal': 'higher',
            'Display_size': 'higher',
            'Display_resolution': 'higher',
            'Body_weight': 'lower',
            'MainCamera_video': 'higher',
            'SelfieCamera_video': 'higher',
            'Battery_charging': 'higher'
        };
        
        // Rules for text comparisons
        const textComparisonRules = {
            'Platform_OS': 'match',
            'Platform_Chipset': 'match',
            'Memory_cardslot': 'match',
            'Network_technology': 'match'
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            phone1Search.addEventListener('input', () => searchPhones(phone1Search.value, suggestions1));
            phone2Search.addEventListener('input', () => searchPhones(phone2Search.value, suggestions2));
            compareButton.addEventListener('click', comparePhones);
            
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#suggestions1') && !e.target.closest('#phone1Search')) {
                    suggestions1.style.display = 'none';
                }
                if (!e.target.closest('#suggestions2') && !e.target.closest('#phone2Search')) {
                    suggestions2.style.display = 'none';
                }
            });
        });
        
        // Search phones using our API
        async function searchPhones(query, suggestionsContainer) {
            if (query.length < 2) {
                suggestionsContainer.style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`/api/search?query=${encodeURIComponent(query)}`);
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.length > 0) {
                    suggestionsContainer.innerHTML = '';
                    data.forEach(phone => {
                        const item = document.createElement('div');
                        item.className = 'compare-suggestion-item';
                        item.textContent = phone.name;
                        item.onclick = () => selectPhone(phone, suggestionsContainer.id);
                        suggestionsContainer.appendChild(item);
                    });
                    suggestionsContainer.style.display = 'block';
                } else {
                    suggestionsContainer.style.display = 'none';
                }
            } catch (error) {
                console.error('Error searching phones:', error);
                showApiError();
            }
        }
        
        // Show API error message
        function showApiError() {
            apiError.style.display = 'block';
            setTimeout(() => {
                apiError.style.display = 'none';
            }, 5000);
        }
        
        // Select a phone from suggestions
        function selectPhone(phone, containerId) {
            const isPhone1 = containerId === 'suggestions1';
            
            if (isPhone1) {
                selectedPhone1 = phone;
                phone1Search.value = phone.name;
                suggestions1.style.display = 'none';
            } else {
                selectedPhone2 = phone;
                phone2Search.value = phone.name;
                suggestions2.style.display = 'none';
            }
            
            compareButton.disabled = !(selectedPhone1 && selectedPhone2);
        }
        
        // Compare the two selected phones
        async function comparePhones() {
            if (!selectedPhone1 || !selectedPhone2) return;
            
            compareButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> შედარება მიმდინარეობს...';
            compareButton.disabled = true;
            
            try {
                const phone1Details = await fetchPhoneDetails(selectedPhone1._id);
                const phone2Details = await fetchPhoneDetails(selectedPhone2._id);
                
                comparisonGrid.style.display = 'block';
                aiAnalysis.style.display = 'block';
                
                phone1Title.textContent = phone1Details.name;
                phone2Title.textContent = phone2Details.name;
                phone1Thumb.src = phone1Details.image_url || '';
                phone2Thumb.src = phone2Details.image_url || '';
                
                buildComparisonGrid(phone1Details, phone2Details);
                comparisonGrid.scrollIntoView({ behavior: 'smooth', block: 'start' });
                await performAiAnalysis(phone1Details, phone2Details);
                
            } catch (error) {
                console.error('Error comparing phones:', error);
                aiContent.innerHTML = '<div class="alert alert-danger">დაფიქსირდა შეცდომა ტელეფონების შედარებისას: ' + error.message + '</div>';
                showApiError();
            } finally {
                compareButton.innerHTML = '<i class="fas fa-exchange-alt me-2"></i>შედარების დაწყება';
                compareButton.disabled = false;
            }
        }
        
        // Fetch phone details from our API
        async function fetchPhoneDetails(phoneId) {
            try {
                const response = await fetch(`/api/phone_details/${phoneId}`);
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching phone details:', error);
                throw error;
            }
        }
        
        // Build the comparison grid
        function buildComparisonGrid(phone1, phone2) {
            while (specsGrid.children.length > 3) {
                specsGrid.removeChild(specsGrid.lastChild);
            }
            
            const specGroups = [
                { key: 'Network', label: 'ქსელი' },
                { key: 'Body', label: 'კორპუსი' },
                { key: 'Display', label: 'ეკრანი' },
                { key: 'Platform', label: 'პლატფორმა' },
                { key: 'Memory', label: 'მეხსიერება' },
                { key: 'MainCamera', label: 'მთავარი კამერა' },
                { key: 'SelfieCamera', label: 'წინა კამერა' },
                { key: 'Sound', label: 'ხმა' },
                { key: 'Comms', label: 'კავშირი' },
                { key: 'Features', label: 'ფუნქციები' },
                { key: 'Battery', label: 'ბატარეა' },
                { key: 'Misc', label: 'დამატებით' }
            ];
            
            specGroups.forEach(group => {
                const groupHeader = document.createElement('div');
                groupHeader.className = 'group-header';
                groupHeader.textContent = group.label;
                specsGrid.appendChild(groupHeader);
                
                const groupSpecs = {};
                const prefix = group.key + '_';
                const allKeys = new Set();
                
                if (phone1.specs) {
                    for (const key in phone1.specs) {
                        if (key.startsWith(prefix)) {
                            const cleanKey = key.substring(prefix.length);
                            groupSpecs[cleanKey] = groupSpecs[cleanKey] || {};
                            groupSpecs[cleanKey].phone1 = phone1.specs[key];
                            allKeys.add(cleanKey);
                        }
                    }
                }
                
                if (phone2.specs) {
                    for (const key in phone2.specs) {
                        if (key.startsWith(prefix)) {
                            const cleanKey = key.substring(prefix.length);
                            groupSpecs[cleanKey] = groupSpecs[cleanKey] || {};
                            groupSpecs[cleanKey].phone2 = phone2.specs[key];
                            allKeys.add(cleanKey);
                        }
                    }
                }
                
                allKeys.forEach(specKey => {
                    const spec = groupSpecs[specKey] || {};
                    const value1 = spec.phone1 || 'N/A';
                    const value2 = spec.phone2 || 'N/A';
                    
                    const nameRow = document.createElement('div');
                    nameRow.className = 'spec-cell spec-name';
                    nameRow.textContent = specKey;
                    specsGrid.appendChild(nameRow);
                    
                    const valueRow = document.createElement('div');
                    valueRow.className = 'spec-row';
                    
                    const value1Cell = document.createElement('div');
                    value1Cell.className = 'spec-cell spec-value';
                    
                    const dividerCell = document.createElement('div');
                    dividerCell.className = 'divider-cell';
                    dividerCell.innerHTML = '<div class="divider-line"></div>';
                    
                    const value2Cell = document.createElement('div');
                    value2Cell.className = 'spec-cell spec-value';
                    
                    const comparison = compareSpecValues(specKey, value1, value2);
                    
                    let content1 = value1;
                    let content2 = value2;
                    
                    if (comparison.phone1 === 'better') {
                        content1 = '<i class="fas fa-check-circle text-success value-indicator"></i>' + content1;
                        value1Cell.classList.add('better-value');
                    }
                    
                    if (comparison.phone2 === 'better') {
                        content2 = '<i class="fas fa-check-circle text-success value-indicator"></i>' + content2;
                        value2Cell.classList.add('better-value');
                    }
                    
                    value1Cell.innerHTML = content1;
                    value2Cell.innerHTML = content2;
                    
                    valueRow.appendChild(value1Cell);
                    valueRow.appendChild(dividerCell);
                    valueRow.appendChild(value2Cell);
                    
                    specsGrid.appendChild(valueRow);
                });
            });
        }
        
        // Compare two spec values
        function compareSpecValues(specKey, value1, value2) {
            const result = { phone1: 'equal', phone2: 'equal' };
            
            if (value1 === 'N/A' || value2 === 'N/A') {
                return result;
            }
            
            if (numericComparisonRules[specKey]) {
                const num1 = extractNumber(value1);
                const num2 = extractNumber(value2);
                
                if (isNaN(num1) || isNaN(num2)) {
                    return result;
                }
                
                if (numericComparisonRules[specKey] === 'higher') {
                    if (num1 > num2) result.phone1 = 'better';
                    if (num2 > num1) result.phone2 = 'better';
                } else {
                    if (num1 < num2) result.phone1 = 'better';
                    if (num2 < num1) result.phone2 = 'better';
                }
            }
            else if (textComparisonRules[specKey] === 'match') {
                if (value1.toLowerCase().includes(value2.toLowerCase())) {
                    result.phone2 = 'better';
                } else if (value2.toLowerCase().includes(value1.toLowerCase())) {
                    result.phone1 = 'better';
                }
            }
            
            return result;
        }
        
        // Extract number from string
        function extractNumber(str) {
            const match = str.match(/(\d+[\.,]?\d*)/);
            return match ? parseFloat(match[0].replace(',', '.')) : NaN;
        }
        
        // Perform AI analysis using our API
        async function performAiAnalysis(phone1, phone2) {
            aiContent.innerHTML = `
                <div class="compare-ai-loader">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Kodi.ge AI ხდის დეტალურ შედარებას...</p>
                </div>
            `;
            
            try {
                const response = await fetch('/api/ai-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        phone1: phone1,
                        phone2: phone2
                    })
                });
                
                if (!response.ok) {
                    throw new Error('AI analysis failed');
                }
                
                const data = await response.json();
                
                aiContent.innerHTML = `
                    <div class="compare-ai-response">
                        <p>${data.analysis}</p>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error performing AI analysis:', error);
                aiContent.innerHTML = '<div class="alert alert-danger">დაფიქსირდა შეცდომა AI ანალიზის დროს. გთხოვთ სცადოთ ხელახლა.</div>';
            }
        }
    </script>
</body>
</html>
