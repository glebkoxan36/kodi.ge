<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - IMEI Checker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="static/admindashboard.css">
</head>
<body>
    <!-- Top navigation bar with user info -->
    <div class="top-bar">
        <div class="d-flex justify-content-between align-items-center py-2">
            <button class="btn btn-outline-secondary d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu">
                <i class="bi bi-list"></i>
            </button>
            <h1 class="h4 mb-0 d-none d-md-block">Admin Panel</h1>
            <div>
                {% if 'admin_username' in session or (currentUser and currentUser.admin_username) %}
                    <div class="dropdown">
                        <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-fill"></i> 
                            {{ session.admin_username if 'admin_username' in session else currentUser.admin_username }}
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            {% if currentUser and currentUser.is_impersonation %}
                                <li><a class="dropdown-item" href="{{ url_for('admin.switch_back') }}">
                                    <i class="bi bi-arrow-left-right me-1"></i> Switch Back
                                </a></li>
                            {% endif %}
                            <li><a class="dropdown-item" href="{{ url_for('auth.admin_logout') }}">
                                <i class="bi bi-box-arrow-right me-1"></i> Logout
                            </a></li>
                        </ul>
                    </div>
                {% else %}
                    <a href="{{ url_for('auth.admin_login') }}" class="btn btn-outline-primary">
                        <i class="bi bi-box-arrow-in-right"></i> Admin Login
                    </a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="main-container">
        <!-- Offcanvas sidebar for mobile -->
        <div class="offcanvas offcanvas-start d-lg-none" tabindex="-1" id="sidebarMenu" aria-labelledby="sidebarMenuLabel">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="sidebarMenuLabel">Admin Menu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body p-0">
                <div class="sidebar">
                    <div class="sidebar-sticky">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link {% if request.endpoint == 'admin.admin_dashboard' %}active{% endif %}" 
                                   href="{{ url_for('admin.admin_dashboard') }}">
                                    <i class="bi bi-speedometer2"></i> Dashboard
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link {% if request.endpoint == 'admin.price_management' %}active{% endif %}" 
                                   href="{{ url_for('admin.price_management') }}">
                                    <i class="bi bi-currency-dollar"></i> Price Management
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link {% if request.endpoint == 'admin.check_history' %}active{% endif %}" 
                                   href="{{ url_for('admin.check_history') }}">
                                    <i class="bi bi-clock-history"></i> Check History
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link {% if request.endpoint in ['admin.db_management', 'admin.collection_view', 'admin.edit_document', 'admin.add_document'] %}active{% endif %}" 
                                   href="{{ url_for('admin.db_management') }}">
                                    <i class="bi bi-database"></i> Database Management
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link {% if request.endpoint == 'admin.manage_users' %}active{% endif %}" 
                                   href="{{ url_for('admin.manage_users') }}">
                                    <i class="bi bi-people"></i> Admin Users
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link {% if request.endpoint == 'admin.manage_regular_users' %}active{% endif %}" 
                                   href="{{ url_for('admin.manage_regular_users') }}">
                                    <i class="bi bi-people-fill"></i> User Management
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link {% if request.endpoint == 'admin.system_status' %}active{% endif %}" 
                                   href="{{ url_for('admin.system_status') }}">
                                    <i class="bi bi-heart-pulse"></i> System Status
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link {% if request.endpoint == 'admin.manage_api_keys' %}active{% endif %}" 
                                   href="{{ url_for('admin.manage_api_keys') }}">
                                    <i class="bi bi-key"></i> API Keys
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link {% if request.endpoint == 'admin.manage_webhooks' %}active{% endif %}" 
                                   href="{{ url_for('admin.manage_webhooks') }}">
                                    <i class="bi bi-send"></i> Webhooks
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Permanent sidebar for desktop -->
        <div class="sidebar d-none d-lg-block">
            <div class="sidebar-sticky">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'admin.admin_dashboard' %}active{% endif %}" 
                           href="{{ url_for('admin.admin_dashboard') }}">
                            <i class="bi bi-speedometer2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'admin.price_management' %}active{% endif %}" 
                           href="{{ url_for('admin.price_management') }}">
                            <i class="bi bi-currency-dollar"></i> Price Management
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'admin.check_history' %}active{% endif %}" 
                           href="{{ url_for('admin.check_history') }}">
                            <i class="bi bi-clock-history"></i> Check History
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint in ['admin.db_management', 'admin.collection_view', 'admin.edit_document', 'admin.add_document'] %}active{% endif %}" 
                           href="{{ url_for('admin.db_management') }}">
                            <i class="bi bi-database"></i> Database Management
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'admin.manage_users' %}active{% endif %}" 
                           href="{{ url_for('admin.manage_users') }}">
                            <i class="bi bi-people"></i> Admin Users
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'admin.manage_regular_users' %}active{% endif %}" 
                           href="{{ url_for('admin.manage_regular_users') }}">
                            <i class="bi bi-people-fill"></i> User Management
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'admin.system_status' %}active{% endif %}" 
                           href="{{ url_for('admin.system_status') }}">
                            <i class="bi bi-heart-pulse"></i> System Status
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'admin.manage_api_keys' %}active{% endif %}" 
                           href="{{ url_for('admin.manage_api_keys') }}">
                            <i class="bi bi-key"></i> API Keys
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'admin.manage_webhooks' %}active{% endif %}" 
                                   href="{{ url_for('admin.manage_webhooks') }}">
                            <i class="bi bi-send"></i> Webhooks
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <div class="main-content">
            <div class="container">
                <!-- Content block -->
                <div class="container mt-3 mt-md-4">
                    {% if request.endpoint == 'admin.admin_dashboard' %}
                        <!-- ========================================== -->
                        <!-- Dashboard Section -->
                        <!-- ========================================== -->
                        <div class="row g-3">
                            <div class="col-md-3 col-6">
                                <div class="stat-card">
                                    <div class="stat-value">{{ total_checks }}</div>
                                    <div class="stat-label">Total Checks</div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="stat-card">
                                    <div class="stat-value text-success">{{ paid_checks }}</div>
                                    <div class="stat-label">Paid Checks</div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="stat-card">
                                    <div class="stat-value">{{ free_checks }}</div>
                                    <div class="stat-label">Free Checks</div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="stat-card">
                                    <div class="stat-value revenue">${{ "%.2f"|format(total_revenue) }}</div>
                                    <div class="stat-label">Total Revenue</div>
                                </div>
                            </div>
                        </div>
                    
                      
{% elif request.endpoint == 'admin.price_management' %}
<!-- ========================================== -->
<!-- Price Management Section -->
<!-- ========================================== -->
<div class="row g-3">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Service Price Management</h5>
            </div>
            <div class="card-body">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                
                <form method="POST">
                    <!-- CSRF Token -->
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    
                    <div class="row">
                        <!-- Apple Services -->
                        <div class="col-md-6">
                            <h4 class="mb-3 border-bottom pb-2">Apple Services</h4>
                            {% for service in apple_services %}
                            <div class="form-section mb-3">
                                <label class="form-label fw-bold text-capitalize">{{ service|replace('_', ' ') }}</label>
                                <div class="input-group input-group-price">
                                    <span class="input-group-text">₾</span>
                                    <input type="number" step="0.01" min="0" max="99.99" 
                                           class="form-control" 
                                           name="{{ service }}" 
                                           value="{{ current_prices[service] | default(0) }}" 
                                           required>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <!-- Android Services -->
                        <div class="col-md-6">
                            <h4 class="mb-3 border-bottom pb-2">Android Services</h4>
                            {% for service in android_services %}
                            <div class="form-section mb-3">
                                <label class="form-label fw-bold text-capitalize">{{ service|replace('_', ' ') }}</label>
                                <div class="input-group input-group-price">
                                    <span class="input-group-text">₾</span>
                                    <input type="number" step="0.01" min="0" max="99.99" 
                                           class="form-control" 
                                           name="{{ service }}" 
                                           value="{{ current_prices[service] | default(0) }}" 
                                           required>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-success w-100 mt-4">
                        <i class="bi bi-save me-1"></i> Update All Prices
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Price Change History</h5>
            </div>
            <div class="card-body price-history">
                {% if price_history %}
                    {% for item in price_history %}
                    <div class="history-item mb-3 p-3 border rounded">
                        <div class="d-flex justify-content-between mb-2">
                            <div class="fw-bold">{{ item.changed_at }}</div>
                            <div class="text-muted">Changed by: {{ item.changed_by }}</div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Apple Services</h6>
                                <ul class="list-group list-group-flush">
                                    {% for service in apple_services %}
                                    {% if service in item.prices %}
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>{{ service|replace('_', ' ') }}:</span>
                                        <span>₾{{ "%.2f"|format(item.prices[service]) }}</span>
                                    </li>
                                    {% endif %}
                                    {% endfor %}
                                </ul>
                            </div>
                            
                            <div class="col-md-6">
                                <h6>Android Services</h6>
                                <ul class="list-group list-group-flush">
                                    {% for service in android_services %}
                                    {% if service in item.prices %}
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>{{ service|replace('_', ' ') }}:</span>
                                        <span>₾{{ "%.2f"|format(item.prices[service]) }}</span>
                                    </li>
                                    {% endif %}
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-muted py-3">
                        No price history available
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
                
                    
                    {% elif request.endpoint == 'admin.check_history' %}
                        <!-- ========================================== -->
                        <!-- Check History Section -->
                        <!-- ========================================== -->
                        <div class="card">
                            <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-md-center">
                                <h5 class="mb-2 mb-md-0">Check History</h5>
                                <div>
                                    <span class="badge paid-badge me-1">Paid: ${{ "%.2f"|format(current_prices.paid) }}</span>
                                    <span class="badge bg-primary">Premium: ${{ "%.2f"|format(current_prices.premium) }}</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <form class="row g-2 mb-3" method="get">
                                    <div class="col-md-8">
                                        <input type="text" class="form-control" name="imei" 
                                               placeholder="Search by IMEI..." value="{{ imei_query }}">
                                    </div>
                                    <div class="col-md-2">
                                        <button type="submit" class="btn btn-primary w-100">Search</button>
                                    </div>
                                    <div class="col-md-2">
                                        <a href="{{ url_for('admin.check_history') }}" class="btn btn-outline-secondary w-100">Reset</a>
                                    </div>
                                </form>
                                
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Timestamp</th>
                                                <th>IMEI</th>
                                                <th>Service</th>
                                                <th>Amount</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for check in checks %}
                                            <tr>
                                                <td>{{ check.timestamp }}</td>
                                                <td>{{ check.imei }}</td>
                                                <td>
                                                    <span class="badge {% if check.service_type == 'premium' %}bg-primary{% else %}bg-info{% endif %}">
                                                        {{ check.service_type|capitalize }}
                                                    </span>
                                                </td>
                                                <td>
                                                    {% if check.paid %}
                                                        <span class="text-success fw-bold">{{ check.amount }}</span>
                                                    {% else %}
                                                        <span class="text-muted">Free</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if check.paid %}
                                                        <span class="badge bg-success">{{ check.payment_status|capitalize }}</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">N/A</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% else %}
                                            <tr>
                                                <td colspan="5" class="text-center">No records found</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <nav>
                                    <ul class="pagination justify-content-center flex-wrap">
                                        {% if page > 1 %}
                                            <li class="page-item">
                                                <a class="page-link" href="?page={{ page-1 }}&imei={{ imei_query }}">Previous</a>
                                            </li>
                                        {% endif %}
                                        
                                        <li class="page-item active">
                                            <span class="page-link">{{ page }}</span>
                                        </li>
                                        
                                        {% if checks|length == per_page %}
                                            <li class="page-item">
                                                <a class="page-link" href="?page={{ page+1 }}&imei={{ imei_query }}">Next</a>
                                            </li>
                                        {% endif %}
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    
                    {% elif request.endpoint == 'admin.db_management' %}
                        <!-- ========================================== -->
                        <!-- Database Management - Collections List -->
                        <!-- ========================================== -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="mb-0">Database Collections</h3>
                            </div>
                            <div class="card-body">
                                <div class="list-group">
                                    {% for collection in collections %}
                                    <a href="{{ url_for('admin.collection_view', collection_name=collection) }}" 
                                       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                        {{ collection }}
                                        <span class="badge bg-primary rounded-pill">
                                            {{ collection_counts[collection] }}
                                        </span>
                                    </a>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    
                    {% elif request.endpoint == 'admin.collection_view' %}
                        <!-- ========================================== -->
                        <!-- Database Management - Collection View -->
                        <!-- ========================================== -->
                        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3">
                            <h2 class="mb-3 mb-md-0">{{ collection_name }} Collection</h2>
                            <div class="d-flex gap-2">
                                <a href="{{ url_for('admin.add_document', collection_name=collection_name) }}" class="btn btn-success">
                                    <i class="bi bi-plus-circle me-1"></i> Add Document
                                </a>
                                <a href="{{ url_for('admin.db_management') }}" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-left me-1"></i> Back
                                </a>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-md-center">
                                <span>Documents ({{ total }} total)</span>
                                <form class="d-flex mt-2 mt-md-0" method="get">
                                    <input type="text" class="form-control me-2" placeholder="Search..." name="q" value="{{ search_query }}">
                                    <button type="submit" class="btn btn-primary">Search</button>
                                </form>
                            </div>
                            
                            <div class="card-body">
                                {% with messages = get_flashed_messages(with_categories=true) %}
                                    {% if messages %}
                                        {% for category, message in messages %}
                                            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                                {{ message }}
                                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                            </div>
                                        {% endfor %}
                                    {% endif %}
                                {% endwith %}
                                
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                {% if documents %}
                                                    {% for key in documents[0].keys() %}
                                                        {% if key != '_id' %}
                                                            <th>{{ key }}</th>
                                                        {% endif %}
                                                    {% endfor %}
                                                {% endif %}
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for doc in documents %}
                                            <tr>
                                                <td class="document-id">{{ doc._id|truncate(8) }}</td>
                                                {% for key, value in doc.items() %}
                                                    {% if key != '_id' %}
                                                        <td>
                                                            {% if value is string and value|length > 50 %}
                                                                {{ value[:50] }}...
                                                            {% elif value is mapping or value is sequence %}
                                                                [Complex Data]
                                                            {% else %}
                                                                {{ value }}
                                                            {% endif %}
                                                        </td>
                                                    {% endif %}
                                                {% endfor %}
                                                <td class="actions-cell">
                                                    <a href="{{ url_for('admin.edit_document', collection_name=collection_name, doc_id=doc._id) }}" 
                                                       class="btn btn-sm btn-primary">
                                                        <i class="bi bi-pencil"></i>
                                                    </a>
                                                    <form method="POST" action="{{ url_for('admin.collection_view', collection_name=collection_name) }}" 
                                                          class="d-inline">
                                                        <!-- CSRF Token -->
                                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                        <input type="hidden" name="doc_id" value="{{ doc._id }}">
                                                        <button type="submit" class="btn btn-sm btn-danger ms-1" 
                                                                onclick="return confirm('Are you sure you want to delete this document?')">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </form>
                                                </td>
                                            </tr>
                                            {% else %}
                                            <tr>
                                                <td colspan="100" class="text-center py-4">No documents found</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Pagination -->
                                <nav>
                                    <ul class="pagination justify-content-center flex-wrap">
                                        {% if page > 1 %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ page - 1 }}&q={{ search_query }}">Previous</a>
                                        </li>
                                        {% endif %}
                                        
                                        {% for p in range(1, (total//per_page)+2) %}
                                            {% if p >= page-2 and p <= page+2 %}
                                                <li class="page-item {% if p == page %}active{% endif %}">
                                                    <a class="page-link" href="?page={{ p }}&q={{ search_query }}">{{ p }}</a>
                                                </li>
                                            {% endif %}
                                        {% endfor %}
                                        
                                        {% if page < (total//per_page)+1 %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ page + 1 }}&q={{ search_query }}">Next</a>
                                        </li>
                                        {% endif %}
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    
                    {% elif request.endpoint == 'admin.edit_document' %}
                        <!-- ========================================== -->
                        <!-- Database Management - Edit Document -->
                        <!-- ========================================== -->
                        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3">
                            <h2 class="mb-3 mb-md-0">Edit Document</h2>
                            <div>
                                <a href="{{ url_for('admin.collection_view', collection_name=collection_name) }}" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-left me-1"></i> Back to Collection
                                </a>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                Collection: {{ collection_name }} | ID: {{ doc_id }}
                            </div>
                            
                            <div class="card-body">
                                {% with messages = get_flashed_messages(with_categories=true) %}
                                    {% if messages %}
                                        {% for category, message in messages %}
                                            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                                {{ message }}
                                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                            </div>
                                        {% endfor %}
                                    {% endif %}
                                {% endwith %}
                                
                                <form method="POST">
                                    <!-- CSRF Token -->
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    
                                    {% for key, value in document.items() %}
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">{{ key }}</label>
                                        {% if key == '_id' %}
                                            <input type="text" class="form-control" 
                                                   name="field_{{ key }}" value="{{ value }}" readonly>
                                        {% elif value is mapping or value is sequence %}
                                            <textarea class="form-control" rows="4" 
                                                      name="field_{{ key }}" 
                                                      placeholder="Enter JSON data">{{ value|tojson }}</textarea>
                                        {% else %}
                                            <input type="text" class="form-control" 
                                                   name="field_{{ key }}" value="{{ value }}">
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                    
                                    <div class="d-flex justify-content-end mt-4">
                                        <button type="submit" class="btn btn-primary me-2">
                                            <i class="bi bi-save me-1"></i> Save Changes
                                        </button>
                                        <a href="{{ url_for('admin.collection_view', collection_name=collection_name) }}" 
                                           class="btn btn-secondary">
                                            Cancel
                                        </a>
                                    </div>
                                </form>
                            </div>
                        </div>
                    
                    {% elif request.endpoint == 'admin.add_document' %}
                        <!-- ========================================== -->
                        <!-- Database Management - Add Document -->
                        <!-- ========================================== -->
                        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3">
                            <h2 class="mb-3 mb-md-0">Add New Document</h2>
                            <div>
                                <a href="{{ url_for('admin.collection_view', collection_name=collection_name) }}" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-left me-1"></i> Back to Collection
                                </a>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                Collection: {{ collection_name }}
                            </div>
                            
                            <div class="card-body">
                                {% with messages = get_flashed_messages(with_categories=true) %}
                                    {% if messages %}
                                        {% for category, message in messages %}
                                            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                                {{ message }}
                                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                            </div>
                                        {% endfor %}
                                    {% endif %}
                                {% endwith %}
                                
                                <form method="POST">
                                    <!-- CSRF Token -->
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    
                                    <div id="fields-container">
                                        <div class="field-group">
                                            <div class="row g-2">
                                                <div class="col-md-5 col-5">
                                                    <input type="text" class="form-control" 
                                                           placeholder="Field name" name="field_names[]" required>
                                                </div>
                                                <div class="col-md-6 col-6">
                                                    <input type="text" class="form-control" 
                                                           placeholder="Value" name="field_values[]" required>
                                                </div>
                                                <div class="col-md-1 col-1">
                                                    <button type="button" class="btn btn-danger remove-field w-100">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mt-3">
                                        <button type="button" id="add-field" class="btn btn-secondary mb-2 mb-md-0">
                                            <i class="bi bi-plus-circle me-1"></i> Add Field
                                        </button>
                                        
                                        <div class="d-flex gap-2">
                                            <button type="submit" class="btn btn-success">
                                                <i class="bi bi-check-circle me-1"></i> Create Document
                                            </button>
                                            <a href="{{ url_for('admin.collection_view', collection_name=collection_name) }}" 
                                               class="btn btn-outline-secondary">
                                                Cancel
                                            </a>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    
                    {% elif request.endpoint == 'admin.manage_users' %}
                        <!-- ========================================== -->
                        <!-- Manage Users Section -->
                        <!-- ========================================== -->
                        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3">
                            <h2 class="mb-3 mb-md-0">Admin Users Management</h2>
                            <a href="{{ url_for('admin.db_management') }}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-1"></i> Back to Collections
                            </a>
                        </div>
                        
                        <div class="card">
                            <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-md-center">
                                <span>Administrators</span>
                                <button type="button" class="btn btn-success mt-2 mt-md-0" data-bs-toggle="modal" data-bs-target="#addUserModal">
                                    <i class="bi bi-plus-circle me-1"></i> Add User
                                </button>
                            </div>
                            
                            <div class="card-body">
                                {% with messages = get_flashed_messages(with_categories=true) %}
                                    {% if messages %}
                                        {% for category, message in messages %}
                                            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                                {{ message }}
                                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                            </div>
                                        {% endfor %}
                                    {% endif %}
                                {% endwith %}
                                
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Username</th>
                                            <th>Role</th>
                                            <th>Created At</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for user in users %}
                                        <tr>
                                            <td>{{ user.username }}</td>
                                            <td>
                                                <span class="badge {% if user.role == 'superadmin' %}bg-primary{% else %}bg-info{% endif %}">
                                                    {{ user.role }}
                                                </span>
                                            </td>
                                            <td>{{ user.created_at }}</td>
                                            <td>
                                                {% if user.role != 'superadmin' %}
                                                    <form method="POST" action="{{ url_for('admin.delete_user', user_id=user._id) }}" class="d-inline">
                                                        <!-- CSRF Token -->
                                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                        <button type="submit" class="btn btn-sm btn-danger" 
                                                                onclick="return confirm('Are you sure you want to delete this user?')">
                                                            <i class="bi bi-trash"></i> Delete
                                                        </button>
                                                    </form>
                                                {% else %}
                                                    <span class="text-muted">System protected</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% else %}
                                        <tr>
                                            <td colspan="4" class="text-center">No users found</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Add User Modal -->
                    <div class="modal fade" id="addUserModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <form method="POST" action="{{ url_for('admin.manage_users') }}">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Add New Admin User</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <!-- CSRF Token -->
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Username</label>
                                            <input type="text" class="form-control" name="username" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Password</label>
                                            <input type="password" class="form-control" name="password" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Role</label>
                                            <select class="form-select" name="role">
                                                <option value="admin">Admin</option>
                                                <option value="manager">Manager</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="submit" class="btn btn-primary">Create User</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    {% elif request.endpoint == 'admin.manage_regular_users' %}
                    <!-- User Management Section -->
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3">
                        <h2 class="mb-3 mb-md-0">User Management</h2>
                        <form class="d-flex mt-2 mt-md-0" method="get">
                            <input type="text" class="form-control me-2" placeholder="Search users..." name="search" value="{{ search_query }}">
                            <button type="submit" class="btn btn-primary">Search</button>
                        </form>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <span>Regular Users ({{ total }} total)</span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Username</th>
                                            <th>Email</th>
                                            <th>Name</th>
                                            <th>Balance</th>
                                            <th>Status</th>
                                            <th>Joined</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for user in users %}
                                        <tr>
                                            <td class="document-id">{{ user._id|truncate(8) }}</td>
                                            <td>{{ user.username }}</td>
                                            <td>{{ user.email }}</td>
                                            <td>{{ user.first_name }} {{ user.last_name }}</td>
                                            <td>{{ user.balance }} ₾</td>
                                            <td>
                                                {% if user.is_blocked %}
                                                    <span class="badge bg-danger">Blocked</span>
                                                {% else %}
                                                    <span class="badge bg-success">Active</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ user.created_at }}</td>
                                            <td class="actions-cell">
                                                <a href="{{ url_for('admin.view_regular_user', user_id=user._id) }}" 
                                                   class="btn btn-sm btn-primary me-1">
                                                    <i class="bi bi-eye"></i>
                                                </a>
                                                <a href="{{ url_for('admin.edit_regular_user', user_id=user._id) }}" 
                                                   class="btn btn-sm btn-warning">
                                                    <i class="bi bi-pencil"></i>
                                                </a>
                                            </td>
                                        </tr>
                                        {% else %}
                                        <tr>
                                            <td colspan="8" class="text-center">No users found</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Pagination -->
                            <nav>
                                <ul class="pagination justify-content-center flex-wrap">
                                    {% if page > 1 %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ page-1 }}&search={{ search_query }}">Previous</a>
                                    </li>
                                    {% endif %}
                                    
                                    {% for p in range(1, (total//per_page)+2) %}
                                        {% if p >= page-2 and p <= page+2 %}
                                            <li class="page-item {% if p == page %}active{% endif %}">
                                                <a class="page-link" href="?page={{ p }}&search={{ search_query }}">{{ p }}</a>
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {% if page < (total//per_page)+1 %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ page+1 }}&search={{ search_query }}">Next</a>
                                    </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        </div>
                    </div>

                    {% elif request.endpoint == 'admin.view_regular_user' %}
                    <!-- View User Section -->
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3">
                        <h2 class="mb-3 mb-md-0">User: {{ user.username }}</h2>
                        <a href="{{ url_for('admin.manage_regular_users') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-1"></i> Back to Users
                        </a>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">Profile</div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-4 fw-bold">ID:</div>
                                        <div class="col-8">{{ user._id }}</div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-4 fw-bold">Username:</div>
                                        <div class="col-8">{{ user.username }}</div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-4 fw-bold">Email:</div>
                                        <div class="col-8">{{ user.email }}</div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-4 fw-bold">Full Name:</div>
                                        <div class="col-8">{{ user.first_name }} {{ user.last_name }}</div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-4 fw-bold">Phone:</div>
                                        <div class="col-8">{{ user.phone }}</div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-4 fw-bold">Balance:</div>
                                        <div class="col-8">{{ user.balance }} ₾</div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-4 fw-bold">Status:</div>
                                        <div class="col-8">
                                            {% if user.is_blocked %}
                                                <span class="badge bg-danger">Blocked</span>
                                            {% else %}
                                                <span class="badge bg-success">Active</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-4 fw-bold">Role:</div>
                                        <div class="col-8">{{ user.role }}</div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-4 fw-bold">Joined:</div>
                                        <div class="col-8">{{ user.created_at }}</div>
                                    </div>
                                    <div class="mt-4 d-flex flex-wrap gap-2">
                                        <a href="{{ url_for('admin.edit_regular_user', user_id=user._id) }}" class="btn btn-primary me-2">
                                            <i class="bi bi-pencil me-1"></i> Edit Profile
                                        </a>
                                        
                                        <form method="POST" action="{{ url_for('admin.block_regular_user', user_id=user._id) }}" class="d-inline">
                                            <!-- CSRF Token -->
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            
                                            {% if user.is_blocked %}
                                                <input type="hidden" name="action" value="unblock">
                                                <button type="submit" class="btn btn-success">
                                                    <i class="bi bi-unlock me-1"></i> Unblock
                                                </button>
                                            {% else %}
                                                <input type="hidden" name="action" value="block">
                                                <button type="submit" class="btn btn-danger">
                                                    <i class="bi bi-lock me-1"></i> Block
                                                </button>
                                            {% endif %}
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">Adjust Balance</div>
                                <div class="card-body">
                                    <form method="POST" action="{{ url_for('admin.adjust_user_balance', user_id=user._id) }}">
                                        <!-- CSRF Token -->
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        
                                        <div class="input-group">
                                            <input type="number" step="0.01" min="0" class="form-control" 
                                                   name="amount" placeholder="Amount" required>
                                            <select class="form-select" name="operation">
                                                <option value="add">Add funds</option>
                                                <option value="subtract">Deduct funds</option>
                                            </select>
                                            <button type="submit" class="btn btn-primary">Apply</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">Recent Checks</div>
                                <div class="card-body">
                                    {% if checks %}
                                        <div class="list-group">
                                            {% for check in checks %}
                                            <div class="list-group-item">
                                                <div class="d-flex w-100 justify-content-between">
                                                    <h6 class="mb-1">{{ check.imei }}</h6>
                                                    <small>{{ check.timestamp }}</small>
                                                </div>
                                                <p class="mb-1">Service: {{ check.service_type }}</p>
                                                <small>Status: {{ check.status }}</small>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <p class="text-center text-muted">No checks found</p>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">Recent Payments</div>
                                <div class="card-body">
                                    {% if payments %}
                                        <div class="list-group">
                                            {% for payment in payments %}
                                            <div class="list-group-item">
                                                <div class="d-flex w-100 justify-content-between">
                                                    <h6 class="mb-1">Payment #{{ payment._id|truncate(6) }}</h6>
                                                    <small>{{ payment.timestamp }}</small>
                                                </div>
                                                <p class="mb-1">Amount: {{ payment.amount }} ₾</p>
                                                <small>Status: {{ payment.status }}</small>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <p class="text-center text-muted">No payments found</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    {% elif request.endpoint == 'admin.edit_regular_user' %}
                    <!-- Edit User Section -->
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3">
                        <h2 class="mb-3 mb-md-0">Edit User: {{ user.username }}</h2>
                        <a href="{{ url_for('admin.view_regular_user', user_id=user._id) }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-1"></i> Back to User
                        </a>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">Edit User Profile</div>
                        <div class="card-body">
                            <form method="POST">
                                <!-- CSRF Token -->
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">First Name</label>
                                        <input type="text" class="form-control" name="first_name" value="{{ user.first_name }}">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Last Name</label>
                                        <input type="text" class="form-control" name="last_name" value="{{ user.last_name }}">
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Email</label>
                                        <input type="email" class="form-control" name="email" value="{{ user.email }}">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Username</label>
                                        <input type="text" class="form-control" name="username" value="{{ user.username }}">
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Phone</label>
                                        <input type="text" class="form-control" name="phone" value="{{ user.phone }}">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Balance (₾)</label>
                                        <input type="number" step="0.01" class="form-control" name="balance" value="{{ user.balance }}">
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Role</label>
                                        <select class="form-select" name="role">
                                            <option value="user" {% if user.role == 'user' %}selected{% endif %}>User</option>
                                            <option value="premium" {% if user.role == 'premium' %}selected{% endif %}>Premium</option>
                                            <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>Admin</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Blocked</label>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" name="is_blocked" 
                                                   {% if user.is_blocked %}checked{% endif %}>
                                            <label class="form-check-label">Block this user</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-end mt-4">
                                    <button type="submit" class="btn btn-primary me-2">Save Changes</button>
                                    <a href="{{ url_for('admin.view_regular_user', user_id=user._id) }}" class="btn btn-secondary">Cancel</a>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    {% elif request.endpoint == 'admin.system_status' %}
                    <!-- System Status Section -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="mb-0">System Status</h3>
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-3 col-6">
                                    <div class="stat-card">
                                        <div class="stat-value">{{ system_stats.total_checks }}</div>
                                        <div class="stat-label">Total Checks</div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="stat-card">
                                        <div class="stat-value">{{ system_stats.active_webhooks }}</div>
                                        <div class="stat-label">Active Webhooks</div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="stat-card">
                                        <div class="stat-value">{{ system_stats.valid_api_keys }}</div>
                                        <div class="stat-label">Valid API Keys</div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="stat-card">
                                        <div class="stat-value">{{ (system_stats.db_size / 1024 / 1024)|round(2) }} MB</div>
                                        <div class="stat-label">Database Size</div>
                                    </div>
                                </div>
                            </div>

                            <h4 class="mb-3">Service Status</h4>
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Service</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for service, status in health_data.services.items() %}
                                        <tr>
                                            <td>{{ service|upper }}</td>
                                            <td>
                                                <span class="badge {% if 'OK' in status %}bg-success{% else %}bg-danger{% endif %}">
                                                    {{ status }}
                                                </span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                            <h4 class="mt-4 mb-3">Recent Audit Events</h4>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Timestamp</th>
                                            <th>User</th>
                                            <th>Action</th>
                                            <th>Details</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for event in audit_events %}
                                        <tr>
                                            <td>{{ event.timestamp }}</td>
                                            <td>{{ event.username }}</td>
                                            <td>{{ event.action }}</td>
                                            <td>
                                                <small>{{ event.details|tojson }}</small>
                                            </td>
                                        </tr>
                                        {% else %}
                                        <tr>
                                            <td colspan="4" class="text-center">No audit events</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    {% elif request.endpoint == 'admin.manage_api_keys' %}
                    <!-- API Keys Management -->
                    <div class="card">
                        <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-md-center">
                            <h3 class="mb-0">API Keys Management</h3>
                            <button type="button" class="btn btn-success mt-2 mt-md-0" data-bs-toggle="modal" data-bs-target="#addApiKeyModal">
                                <i class="bi bi-plus-circle me-1"></i> Add API Key
                            </button>
                        </div>
                        <div class="card-body">
                            {% with messages = get_flashed_messages(with_categories=true) %}
                                {% if messages %}
                                    {% for category, message in messages %}
                                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                            {{ message }}
                                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                        </div>
                                    {% endfor %}
                                {% endif %}
                            {% endwith %}
                            
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Key</th>
                                            <th>Permissions</th>
                                            <th>Created</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for key in api_keys %}
                                        <tr>
                                            <td>{{ key.name }}</td>
                                            <td class="document-id">{{ key.key|truncate(16) }}</td>
                                            <td>
                                                {% for perm in key.permissions %}
                                                <span class="badge bg-info me-1">{{ perm }}</span>
                                                {% endfor %}
                                            </td>
                                            <td>{{ key.created_at }}</td>
                                            <td>
                                                {% if key.revoked %}
                                                <span class="badge bg-danger">Revoked</span>
                                                {% else %}
                                                <span class="badge bg-success">Active</span>
                                                {% endif %}
                                            </td>
                                            <td class="actions-cell">
                                                {% if not key.revoked %}
                                                <form method="POST" action="{{ url_for('admin.revoke_api_key', key_id=key._id) }}" class="d-inline me-1">
                                                    <!-- CSRF Token -->
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                    <button type="submit" class="btn btn-sm btn-warning me-1">
                                                        <i class="bi bi-x-circle"></i> Revoke
                                                    </button>
                                                </form>
                                                {% endif %}
                                                <form method="POST" action="{{ url_for('admin.delete_api_key', key_id=key._id) }}" class="d-inline">
                                                    <!-- CSRF Token -->
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                    <button type="submit" class="btn btn-sm btn-danger" 
                                                            onclick="return confirm('Permanently delete this API key?')">
                                                        <i class="bi bi-trash"></i> Delete
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                        {% else %}
                                        <tr>
                                            <td colspan="6" class="text-center">No API keys created</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Add API Key Modal -->
                    <div class="modal fade" id="addApiKeyModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <form method="POST" action="{{ url_for('admin.manage_api_keys') }}">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Create New API Key</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <!-- CSRF Token -->
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Name</label>
                                            <input type="text" class="form-control" name="name" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Permissions (comma separated)</label>
                                            <input type="text" class="form-control" name="permissions" 
                                                   placeholder="read_checks, write_checks, manage">
                                            <div class="form-text">Available permissions: read_checks, write_checks, manage</div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Expiration Date (optional)</label>
                                            <input type="date" class="form-control" name="expires_at">
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="submit" class="btn btn-primary">Create Key</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    {% elif request.endpoint == 'admin.manage_webhooks' %}
                    <!-- Webhooks Management -->
                    <div class="card">
                        <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-md-center">
                            <h3 class="mb-0">Webhooks Management</h3>
                            <button type="button" class="btn btn-success mt-2 mt-md-0" data-bs-toggle="modal" data-bs-target="#addWebhookModal">
                                <i class="bi bi-plus-circle me-1"></i> Add Webhook
                            </button>
                        </div>
                        <div class="card-body">
                            {% with messages = get_flashed_messages(with_categories=true) %}
                                {% if messages %}
                                    {% for category, message in messages %}
                                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                            {{ message }}
                                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                        </div>
                                    {% endfor %}
                                {% endif %}
                            {% endwith %}
                            
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>URL</th>
                                            <th>Events</th>
                                            <th>Status</th>
                                            <th>Created</th>
                                            <th>Last Delivery</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for webhook in webhooks %}
                                        <tr>
                                            <td class="document-id">{{ webhook.url|truncate(30) }}</td>
                                            <td>
                                                {% for event in webhook.events %}
                                                <span class="badge bg-info me-1">{{ event }}</span>
                                                {% endfor %}
                                            </td>
                                            <td>
                                                {% if webhook.active %}
                                                <span class="badge bg-success">Active</span>
                                                {% else %}
                                                <span class="badge bg-secondary">Inactive</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ webhook.created_at }}</td>
                                            <td>{{ webhook.last_delivery if webhook.last_delivery else 'Never' }}</td>
                                            <td class="actions-cell">
                                                <form method="POST" action="{{ url_for('admin.toggle_webhook', webhook_id=webhook._id) }}" class="d-inline me-1">
                                                    <!-- CSRF Token -->
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                    <button type="submit" class="btn btn-sm {% if webhook.active %}btn-warning{% else %}btn-success{% endif %}">
                                                        {% if webhook.active %}
                                                        <i class="bi bi-pause"></i> Deactivate
                                                        {% else %}
                                                        <i class="bi bi-play"></i> Activate
                                                        {% endif %}
                                                    </button>
                                                </form>
                                                <form method="POST" action="{{ url_for('admin.delete_webhook', webhook_id=webhook._id) }}" class="d-inline">
                                                    <!-- CSRF Token -->
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                    <button type="submit" class="btn btn-sm btn-danger" 
                                                            onclick="return confirm('Permanently delete this webhook?')">
                                                        <i class="bi bi-trash"></i> Delete
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                        {% else %}
                                        <tr>
                                            <td colspan="6" class="text-center">No webhooks configured</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Add Webhook Modal -->
                    <div class="modal fade" id="addWebhookModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <form method="POST" action="{{ url_for('admin.manage_webhooks') }}">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Create New Webhook</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <!-- CSRF Token -->
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Endpoint URL</label>
                                            <input type="url" class="form-control" name="url" required placeholder="https://example.com/webhook">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Events (comma separated)</label>
                                            <input type="text" class="form-control" name="events" 
                                                   placeholder="imei_check_completed, payment_success" required>
                                            <div class="form-text">Available events: imei_check_completed, payment_success</div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Secret Key (optional)</label>
                                            <input type="text" class="form-control" name="secret" placeholder="Your secret for HMAC verification">
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="submit" class="btn btn-primary">Create Webhook</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Add new field in DB management forms
            document.getElementById('add-field')?.addEventListener('click', function() {
                const container = document.getElementById('fields-container');
                const newField = document.createElement('div');
                newField.className = 'field-group';
                newField.innerHTML = `
                    <div class="row g-2">
                        <div class="col-5 col-md-5">
                            <input type="text" class="form-control" 
                                   placeholder="Field name" name="field_names[]" required>
                        </div>
                        <div class="col-6 col-md-6">
                            <input type="text" class="form-control" 
                                   placeholder="Value" name="field_values[]" required>
                        </div>
                        <div class="col-1 col-md-1">
                            <button type="button" class="btn btn-danger remove-field w-100">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(newField);
            });

            // Remove field in DB management forms
            document.addEventListener('click', function(e) {
                if (e.target && e.target.classList.contains('remove-field')) {
                    e.target.closest('.field-group').remove();
                }
            });
            
            // Auto close mobile menu after click
            const navLinks = document.querySelectorAll('.offcanvas-body .nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', () => {
                    const offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('sidebarMenu'));
                    offcanvas.hide();
                });
            });
        });
    </script>
</body>
                                        </html>
