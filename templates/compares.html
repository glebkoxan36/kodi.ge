<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>База спецификаций телефонов</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='static/compares.css') }}">
</head>
<body>
    <div class="container mt-5">
        <!-- Режимы работы -->
        <div class="mode-switcher mb-4">
            <button id="singleModeBtn" class="btn btn-primary mode-btn active">
                <i class="fas fa-mobile-alt me-2"></i>Одиночный
            </button>
            <button id="compareModeBtn" class="btn btn-outline-primary mode-btn">
                <i class="fas fa-exchange-alt me-2"></i>Сравнение
            </button>
        </div>

        <div class="text-center mb-5">
            <h1 class="display-4 mb-3">База спецификаций телефонов</h1>
            <p class="lead">Найдите и изучите характеристики различных моделей смартфонов</p>
            
            <div class="form-group mt-4" style="max-width: 600px; margin: 0 auto;">
                <div class="input-group">
                    <input type="text" id="phoneSearch" class="form-control form-control-lg" 
                           placeholder="Введите бренд или модель телефона...">
                    <button id="searchBtn" class="btn btn-primary">
                        <i class="fas fa-search me-2"></i>Найти
                    </button>
                </div>
            </div>
        </div>

        <!-- Контейнер для выбора телефонов в режиме сравнения -->
        <div id="compareSelection" class="compare-selection mb-4" style="display: none;">
            <div class="row">
                <div class="col-md-6">
                    <div class="phone-selector">
                        <div class="selector-header">
                            <h4>Телефон 1</h4>
                        </div>
                        <div class="phone-preview" id="phonePreview1">
                            <div class="placeholder">
                                <i class="fas fa-plus"></i>
                                <p>Выберите телефон</p>
                            </div>
                        </div>
                        <button class="btn btn-outline-secondary mt-2 select-phone-btn" data-phone="1">
                            Выбрать телефон
                        </button>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="phone-selector">
                        <div class="selector-header">
                            <h4>Телефон 2</h4>
                        </div>
                        <div class="phone-preview" id="phonePreview2">
                            <div class="placeholder">
                                <i class="fas fa-plus"></i>
                                <p>Выберите телефон</p>
                            </div>
                        </div>
                        <button class="btn btn-outline-secondary mt-2 select-phone-btn" data-phone="2">
                            Выбрать телефон
                        </button>
                    </div>
                </div>
            </div>
            <div class="text-center mt-4">
                <button id="startCompareBtn" class="btn btn-success" disabled>
                    <i class="fas fa-balance-scale me-2"></i>Сравнить
                </button>
                <button id="clearCompareBtn" class="btn btn-outline-danger ms-2">
                    <i class="fas fa-times me-2"></i>Очистить
                </button>
            </div>
        </div>

        <div id="searchResults" class="phone-grid">
            <!-- Результаты поиска будут здесь -->
        </div>

        <div id="phoneDetails" class="specs-container mt-5" style="display: none;">
            <button id="backToResults" class="btn btn-secondary mb-4">
                <i class="fas fa-arrow-left me-2"></i>Назад к результатам
            </button>
            
            <div class="specs-header">
                <div class="specs-phone">
                    <img id="phoneImage" src="" alt="Phone" class="phone-thumb">
                    <div id="phoneTitle" class="mt-3 h3 text-center"></div>
                </div>
            </div>
            
            <div class="spec-items mt-4" id="specsContainer">
                <!-- Спецификации будут здесь -->
            </div>
        </div>

        <!-- Контейнер для сравнения -->
        <div id="compareDetails" class="compare-container mt-5" style="display: none;">
            <button id="backFromCompare" class="btn btn-secondary mb-4">
                <i class="fas fa-arrow-left me-2"></i>Назад к выбору
            </button>
            
            <div class="compare-header">
                <div class="compare-phone">
                    <img id="compareImage1" src="" alt="Phone 1" class="phone-thumb">
                    <div id="compareTitle1" class="mt-3 h4 text-center"></div>
                </div>
                <div class="vs-badge">
                    <span>VS</span>
                </div>
                <div class="compare-phone">
                    <img id="compareImage2" src="" alt="Phone 2" class="phone-thumb">
                    <div id="compareTitle2" class="mt-3 h4 text-center"></div>
                </div>
            </div>
            
            <div class="compare-table mt-4">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Характеристика</th>
                            <th id="compareHeader1"></th>
                            <th id="compareHeader2"></th>
                        </tr>
                    </thead>
                    <tbody id="compareSpecs">
                        <!-- Спецификации для сравнения будут здесь -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Элементы интерфейса
        const phoneSearch = document.getElementById('phoneSearch');
        const searchBtn = document.getElementById('searchBtn');
        const searchResults = document.getElementById('searchResults');
        const phoneDetails = document.getElementById('phoneDetails');
        const phoneTitle = document.getElementById('phoneTitle');
        const phoneImage = document.getElementById('phoneImage');
        const specsContainer = document.getElementById('specsContainer');
        const backToResults = document.getElementById('backToResults');
        
        // Режимы работы
        const singleModeBtn = document.getElementById('singleModeBtn');
        const compareModeBtn = document.getElementById('compareModeBtn');
        const compareSelection = document.getElementById('compareSelection');
        
        // Сравнение
        const compareDetails = document.getElementById('compareDetails');
        const backFromCompare = document.getElementById('backFromCompare');
        const startCompareBtn = document.getElementById('startCompareBtn');
        const clearCompareBtn = document.getElementById('clearCompareBtn');
        const selectPhoneBtns = document.querySelectorAll('.select-phone-btn');
        const phonePreviews = {
            1: document.getElementById('phonePreview1'),
            2: document.getElementById('phonePreview2')
        };
        const compareTitle1 = document.getElementById('compareTitle1');
        const compareTitle2 = document.getElementById('compareTitle2');
        const compareImage1 = document.getElementById('compareImage1');
        const compareImage2 = document.getElementById('compareImage2');
        const compareHeader1 = document.getElementById('compareHeader1');
        const compareHeader2 = document.getElementById('compareHeader2');
        const compareSpecs = document.getElementById('compareSpecs');
        
        // Текущий режим
        let currentMode = 'single'; // 'single' или 'compare'
        
        // Выбранные для сравнения телефоны
        let selectedPhones = {
            1: null,
            2: null
        };
        
        // Кэш данных телефонов
        let phoneCache = {};
        
        // Переключение режимов
        singleModeBtn.addEventListener('click', function() {
            if (currentMode === 'compare') {
                switchMode('single');
            }
        });
        
        compareModeBtn.addEventListener('click', function() {
            if (currentMode === 'single') {
                switchMode('compare');
            }
        });
        
        function switchMode(mode) {
            currentMode = mode;
            
            // Обновление активной кнопки
            singleModeBtn.classList.toggle('active', mode === 'single');
            singleModeBtn.classList.toggle('btn-primary', mode === 'single');
            singleModeBtn.classList.toggle('btn-outline-primary', mode !== 'single');
            
            compareModeBtn.classList.toggle('active', mode === 'compare');
            compareModeBtn.classList.toggle('btn-primary', mode === 'compare');
            compareModeBtn.classList.toggle('btn-outline-primary', mode !== 'compare');
            
            // Показываем/скрываем элементы
            compareSelection.style.display = mode === 'compare' ? 'block' : 'none';
            searchResults.style.display = 'block';
            phoneDetails.style.display = 'none';
            compareDetails.style.display = 'none';
            
            // Очищаем результаты поиска
            searchResults.innerHTML = mode === 'single' 
                ? '<div class="text-center py-4">Введите запрос для поиска телефона</div>'
                : '<div class="text-center py-4">Выберите телефон для сравнения</div>';
            
            // Сбрасываем поисковый запрос
            phoneSearch.value = '';
        }
        
        // Выбор телефона для сравнения
        selectPhoneBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const phoneNum = parseInt(this.getAttribute('data-phone'));
                openPhoneSelection(phoneNum);
            });
        });
        
        function openPhoneSelection(phoneNum) {
            // Сохраняем номер телефона, который выбираем
            sessionStorage.setItem('selectingFor', phoneNum);
            
            // Показываем результаты поиска
            searchResults.style.display = 'block';
            phoneDetails.style.display = 'none';
            compareSelection.style.display = 'none';
            compareDetails.style.display = 'none';
            
            // Заголовок для режима выбора
            searchResults.innerHTML = '<div class="text-center py-4">Выберите телефон для сравнения</div>';
            phoneSearch.focus();
        }
        
        // Кнопка сравнения
        startCompareBtn.addEventListener('click', startComparison);
        
        // Очистка выбора
        clearCompareBtn.addEventListener('click', function() {
            selectedPhones = {
                1: null,
                2: null
            };
            
            // Очищаем превью
            phonePreviews[1].innerHTML = `
                <div class="placeholder">
                    <i class="fas fa-plus"></i>
                    <p>Выберите телефон</p>
                </div>
            `;
            
            phonePreviews[2].innerHTML = `
                <div class="placeholder">
                    <i class="fas fa-plus"></i>
                    <p>Выберите телефон</p>
                </div>
            `;
            
            // Блокируем кнопку сравнения
            startCompareBtn.disabled = true;
        });
        
        // Назад из режима сравнения
        backFromCompare.addEventListener('click', function() {
            compareDetails.style.display = 'none';
            compareSelection.style.display = 'block';
        });
        
        // Функция поиска телефонов
        function searchPhones() {
            const query = phoneSearch.value.trim();
            if (!query) {
                searchResults.innerHTML = '<div class="text-center py-4">Введите запрос для поиска</div>';
                return;
            }
            
            searchResults.innerHTML = '<div class="text-center py-5"><div class="spinner"></div><p>Идет поиск...</p></div>';
            
            fetch(`/compare/search?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    displaySearchResults(data);
                })
                .catch(error => {
                    searchResults.innerHTML = '<div class="text-center py-4">Ошибка при поиске</div>';
                    console.error('Error:', error);
                });
        }

        // Отображение результатов поиска
        function displaySearchResults(phones) {
            if (!phones || phones.length === 0) {
                searchResults.innerHTML = '<div class="text-center py-4">Телефоны не найдены</div>';
                return;
            }

            let html = '<div class="phone-grid">';
            phones.forEach(phone => {
                // Определяем бренд и модель с учетом языка
                const brand = phone.Бренд || phone.Brand || 'Неизвестный бренд';
                const model = phone.Модель || phone.Model || 'Неизвестная модель';
                
                // Формируем путь к изображению
                const imagePath = `/static/img/phones/${brand}/${model}.jpg`.replace(/\s+/g, '_');
                
                // Сохраняем в кэш
                phoneCache[phone._id] = phone;
                
                html += `
                    <div class="phone-card" data-id="${phone._id}">
                        <div class="text-center">
                            <img src="${imagePath}" alt="${brand} ${model}" 
                                 class="phone-thumb" onerror="this.src='/static/placeholder.jpg'">
                        </div>
                        <div class="card-body text-center mt-3">
                            <h5>${brand} ${model}</h5>
                            <p>${phone['Год выпуска'] || phone.Year || ''} • ${phone.ОС || phone.OS || ''}</p>
                            <button class="btn btn-primary view-details-btn">
                                <i class="fas fa-info-circle me-2"></i>${currentMode === 'single' ? 'Подробнее' : 'Выбрать'}
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            searchResults.innerHTML = html;

            // Добавляем обработчики событий
            document.querySelectorAll('.view-details-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const phoneId = this.closest('.phone-card').getAttribute('data-id');
                    
                    if (currentMode === 'single') {
                        loadPhoneDetails(phoneId);
                    } else {
                        selectPhoneForComparison(phoneId);
                    }
                });
            });
        }
        
        // Выбор телефона для сравнения
        function selectPhoneForComparison(phoneId) {
            const phone = phoneCache[phoneId];
            if (!phone) return;
            
            const selectingFor = sessionStorage.getItem('selectingFor');
            if (!selectingFor) return;
            
            const phoneNum = parseInt(selectingFor);
            
            // Сохраняем выбранный телефон
            selectedPhones[phoneNum] = phoneId;
            
            // Обновляем превью
            const brand = phone.Бренд || phone.Brand || 'Неизвестный бренд';
            const model = phone.Модель || phone.Model || 'Неизвестная модель';
            const imagePath = `/static/img/phones/${brand}/${model}.jpg`.replace(/\s+/g, '_');
            
            phonePreviews[phoneNum].innerHTML = `
                <div class="selected-phone">
                    <img src="${imagePath}" alt="${brand} ${model}" 
                         class="phone-thumb-sm" onerror="this.src='/static/placeholder.jpg'">
                    <div class="phone-info">
                        <strong>${brand} ${model}</strong>
                        <div>${phone['Год выпуска'] || phone.Year || ''}</div>
                    </div>
                    <button class="btn btn-sm btn-outline-danger remove-phone" data-phone="${phoneNum}">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            // Добавляем обработчик для кнопки удаления
            phonePreviews[phoneNum].querySelector('.remove-phone').addEventListener('click', function(e) {
                e.stopPropagation();
                const num = this.getAttribute('data-phone');
                selectedPhones[num] = null;
                phonePreviews[num].innerHTML = `
                    <div class="placeholder">
                        <i class="fas fa-plus"></i>
                        <p>Выберите телефон</p>
                    </div>
                `;
                checkCompareReadiness();
            });
            
            // Возвращаемся к выбору телефонов
            compareSelection.style.display = 'block';
            searchResults.style.display = 'none';
            
            // Проверяем готовность к сравнению
            checkCompareReadiness();
        }
        
        // Проверка готовности к сравнению
        function checkCompareReadiness() {
            startCompareBtn.disabled = !(selectedPhones[1] && selectedPhones[2]);
        }
        
        // Запуск сравнения
        function startComparison() {
            const phoneId1 = selectedPhones[1];
            const phoneId2 = selectedPhones[2];
            
            if (!phoneId1 || !phoneId2) return;
            
            const phone1 = phoneCache[phoneId1];
            const phone2 = phoneCache[phoneId2];
            
            if (!phone1 || !phone2) return;
            
            // Показываем контейнер сравнения
            compareSelection.style.display = 'none';
            compareDetails.style.display = 'block';
            
            // Заполняем заголовки
            const brand1 = phone1.Бренд || phone1.Brand || 'Неизвестный бренд';
            const model1 = phone1.Модель || phone1.Model || 'Неизвестная модель';
            const brand2 = phone2.Бренд || phone2.Brand || 'Неизвестный бренд';
            const model2 = phone2.Модель || phone2.Model || 'Неизвестная модель';
            
            compareTitle1.textContent = `${brand1} ${model1}`;
            compareTitle2.textContent = `${brand2} ${model2}`;
            compareHeader1.textContent = `${brand1} ${model1}`;
            compareHeader2.textContent = `${brand2} ${model2}`;
            
            // Загружаем изображения
            const imagePath1 = `/static/img/phones/${brand1}/${model1}.jpg`.replace(/\s+/g, '_');
            const imagePath2 = `/static/img/phones/${brand2}/${model2}.jpg`.replace(/\s+/g, '_');
            
            compareImage1.src = imagePath1;
            compareImage2.src = imagePath2;
            
            compareImage1.onerror = function() { 
                this.src = '/static/placeholder.jpg';
            };
            
            compareImage2.onerror = function() { 
                this.src = '/static/placeholder.jpg';
            };
            
            // Генерируем таблицу сравнения
            generateComparisonTable(phone1, phone2);
        }
        
        // Генерация таблицы сравнения
        function generateComparisonTable(phone1, phone2) {
            // Собираем все уникальные характеристики
            const allSpecs = new Set();
            
            // Исключаемые поля
            const excludeFields = ['_id', 'ID', 'Бренд', 'Brand', 'Модель', 'Model'];
            
            // Добавляем характеристики из первого телефона
            for (const key in phone1) {
                if (!excludeFields.includes(key) && phone1[key]) {
                    allSpecs.add(key);
                }
            }
            
            // Добавляем характеристики из второго телефона
            for (const key in phone2) {
                if (!excludeFields.includes(key) && phone2[key]) {
                    allSpecs.add(key);
                }
            }
            
            // Создаем HTML для таблицы
            let html = '';
            allSpecs.forEach(spec => {
                const value1 = phone1[spec] || '-';
                const value2 = phone2[spec] || '-';
                
                // Определяем класс для выделения различий
                const diffClass = value1 !== value2 ? 'diff-value' : '';
                
                html += `
                    <tr>
                        <td>${spec}</td>
                        <td class="${diffClass}">${value1}</td>
                        <td class="${diffClass}">${value2}</td>
                    </tr>
                `;
            });
            
            compareSpecs.innerHTML = html;
        }

        // Загрузка деталей телефона (режим одиночный)
        function loadPhoneDetails(phoneId) {
            // ... существующая реализация без изменений ...
        }

        // Отображение деталей телефона (режим одиночный)
        function displayPhoneDetails(phone) {
            // ... существующая реализация без изменений ...
        }

        // Обработчики событий для поиска
        searchBtn.addEventListener('click', searchPhones);
        phoneSearch.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') searchPhones();
        });
        
        // Обработчик кнопки "Назад"
        backToResults.addEventListener('click', function() {
            phoneDetails.style.display = 'none';
            searchResults.style.display = 'block';
            searchResults.style.opacity = '1';
            searchResults.innerHTML = currentMode === 'single' 
                ? '<div class="text-center py-4">Введите запрос для поиска телефона</div>'
                : '<div class="text-center py-4">Выберите телефон для сравнения</div>';
            phoneSearch.value = '';
        });
        
        // Инициализация
        searchResults.innerHTML = '<div class="text-center py-4">Введите запрос для поиска телефона</div>';
    });
    </script>
</body>
</html>
