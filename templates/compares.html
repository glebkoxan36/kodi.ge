<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>База спецификаций телефонов</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='compares.css') }}">
</head>
<body>
    <div class="container mt-5">
        <!-- Режимы работы -->
        <div class="mode-switcher mb-4">
            <button id="singleModeBtn" class="btn btn-outline-primary mode-btn">
                <i class="fas fa-mobile-alt me-2"></i>Одиночный
            </button>
            <button id="compareModeBtn" class="btn btn-outline-primary mode-btn">
                <i class="fas fa-exchange-alt me-2"></i>Сравнение
            </button>
        </div>

        <div id="mainContent" style="display: none;">
            <!-- Контейнер для выбора телефонов в режиме сравнения -->
            <div id="compareSelection" class="compare-selection mb-4" style="display: none;">
                <div class="phone-selectors-container">
                    <div class="phone-selector">
                        <div class="selector-header">
                            <h4>Телефон 1</h4>
                        </div>
                        <div class="phone-preview" id="phonePreview1">
                            <div class="placeholder">
                                <i class="fas fa-plus"></i>
                                <p>Выберите телефон</p>
                            </div>
                        </div>
                        <button class="btn btn-outline-secondary mt-2 select-phone-btn" data-phone="1">
                            Выбрать телефон
                        </button>
                    </div>
                    <div class="phone-selector">
                        <div class="selector-header">
                            <h4>Телефон 2</h4>
                        </div>
                        <div class="phone-preview" id="phonePreview2">
                            <div class="placeholder">
                                <i class="fas fa-plus"></i>
                                <p>Выберите телефон</p>
                            </div>
                        </div>
                        <button class="btn btn-outline-secondary mt-2 select-phone-btn" data-phone="2">
                            Выбрать телефон
                        </button>
                    </div>
                </div>
                <div class="compare-controls">
                    <button id="startCompareBtn" class="btn btn-success" disabled>
                        <i class="fas fa-balance-scale me-2"></i>Сравнить
                    </button>
                    <button id="clearCompareBtn" class="btn btn-outline-danger">
                        <i class="fas fa-times me-2"></i>Очистить
                    </button>
                </div>
            </div>

            <div id="searchResults" class="specs-container mt-5" style="display: none;">
                <div class="search-results-header">
                    <div class="search-box">
                        <div class="input-group">
                            <input type="text" id="phoneSearch" class="form-control" 
                                   placeholder="Введите бренд или модель телефона...">
                        </div>
                    </div>
                </div>
                <div class="phone-grid">
                    <!-- Результаты поиска будут здесь -->
                </div>
            </div>

            <div id="phoneDetails" class="specs-container mt-5" style="display: none;">
                <button id="backToResults" class="btn btn-secondary mb-4">
                    <i class="fas fa-arrow-left me-2"></i>Назад к результатам
                </button>
                
                <div class="specs-header">
                    <div class="specs-phone">
                        <img id="phoneImage" src="" alt="Phone" class="phone-thumb">
                        <div id="phoneTitle" class="mt-3 h3 text-center"></div>
                    </div>
                </div>
                
                <div class="spec-items mt-4" id="specsContainer">
                    <!-- Спецификации будут здесь -->
                </div>
            </div>

            <!-- Контейнер для сравнения -->
            <div id="compareDetails" class="compare-container mt-5" style="display: none;">
                <button id="backFromCompare" class="btn btn-secondary mb-4">
                    <i class="fas fa-arrow-left me-2"></i>Назад к выбору
                </button>
                
                <div class="compare-header">
                    <div class="compare-phone">
                        <img id="compareImage1" src="" alt="Phone 1" class="phone-thumb">
                        <div id="compareTitle1" class="mt-3 h4 text-center"></div>
                    </div>
                    <div class="vs-badge">
                        <span>VS</span>
                    </div>
                    <div class="compare-phone">
                        <img id="compareImage2" src="" alt="Phone 2" class="phone-thumb">
                        <div id="compareTitle2" class="mt-3 h4 text-center"></div>
                    </div>
                </div>
                
                <!-- КОНТЕЙНЕР ДЛЯ СПЕЦИФИКАЦИЙ -->
                <div class="compare-specs-grid" id="compareSpecs">
                    <!-- Спецификации для сравнения будут здесь -->
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Весовые коэффициенты для групп характеристик
        const groupWeights = {
            "Основные": 0.05,
            "Дисплей": 0.15,
            "Процессор": 0.25,
            "Камера": 0.20,
            "Батарея": 0.15,
            "Корпус": 0.05,
            "Связь": 0.05,
            "Аудио": 0.03,
            "Безопасность": 0.02,
            "Дополнительно": 0.03,
            "Комплектация": 0.01,
            "Экология": 0.01,
            "Цена": 0.10
        };

        // Правила преобразования нечисловых значений в баллы
        const converters = {
            "Тип дисплея": {
                "AMOLED": 10,
                "OLED": 9,
                "Dynamic AMOLED": 10,
                "Super AMOLED": 9.5,
                "LTPO AMOLED": 10,
                "IPS": 7,
                "TFT": 5,
                "LCD": 6
            },
            "Защитное стекло": {
                "Gorilla Glass Victus 2": 10,
                "Gorilla Glass Victus": 9,
                "Gorilla Glass 7": 8,
                "Gorilla Glass 6": 7,
                "Gorilla Glass 5": 6
            },
            "Материал корпуса": {
                "Титан": 10,
                "Алюминий": 8,
                "Магний": 7,
                "Стекло": 6,
                "Пластик": 4
            },
            "Защита от воды": {
                "IP68": 10,
                "IP67": 8,
                "IP54": 5
            },
            "Тип SIM": {
                "eSIM + nanoSIM": 10,
                "Двойная nanoSIM": 8,
                "nanoSIM + microSD": 7,
                "Одиночная nanoSIM": 5
            },
            "Аудиоразъем": {
                "Есть": 10,
                "Нет": 5
            },
            "Сканер отпечатков": {
                "Ультразвуковой в дисплее": 10,
                "Оптический в дисплее": 8,
                "Боковой": 7,
                "На задней панели": 6
            }
        };

        // Правила сравнения для числовых характеристик
        const comparisonRules = {
            "Размер дисплея (дюймы)": { higherBetter: true },
            "Пиковая яркость (нит)": { higherBetter: true },
            "Частота обновления (Гц)": { higherBetter: true },
            "Плотность пикселей (PPI)": { higherBetter: true },
            "ОЗУ (ГБ)": { higherBetter: true },
            "ПЗУ (ГБ)": { higherBetter: true },
            "Емкость батареи (mAh)": { higherBetter: true },
            "Время работы от батареи (ч)": { higherBetter: true },
            "Пиковая мощность": { higherBetter: true },
            "Оценка AnTuTu": { higherBetter: true },
            "Geekbench (одиночное ядро)": { higherBetter: true },
            "Geekbench (многоядерное)": { higherBetter: true },
            "Основная камера (Мп)": { higherBetter: true },
            "Фронтальная камера (Мп)": { higherBetter: true },
            "Вес (г)": { higherBetter: false },
            "Толщина (мм)": { higherBetter: false },
            "Стартовая цена (руб)": { higherBetter: false },
            "Текущая цена (руб)": { higherBetter: false }
        };

        // Функция для извлечения чисел из строк
        function extractNumber(str) {
            if (!str) return null;
            
            // Попробуем найти число с плавающей точкой
            const match = str.match(/(\d+[\.,]?\d*)/);
            if (match) {
                return parseFloat(match[0].replace(',', '.'));
            }
            
            // Попробуем найти целое число
            const intMatch = str.match(/\d+/);
            if (intMatch) {
                return parseInt(intMatch[0]);
            }
            
            return null;
        }

        // Функция нормализации значений
        function normalizeValue(specName, value) {
            // Если есть специальный конвертер - используем его
            if (converters[specName] && converters[specName][value]) {
                return converters[specName][value];
            }
            
            // Если значение - число, возвращаем как есть
            if (!isNaN(value) && value !== "") {
                return parseFloat(value);
            }
            
            // Пробуем извлечь число из строки
            const num = extractNumber(value);
            if (num !== null) {
                return num;
            }
            
            // Если ничего не получилось - возвращаем исходное значение
            return value;
        }

        // Функция сравнения характеристик
        function compareSpecs(phone1, phone2) {
            const scores = {
                phone1: 0,
                phone2: 0,
                groupScores: {}
            };
            
            // Временные хранилища для промежуточных баллов
            const groupPoints = {
                phone1: {},
                phone2: {}
            };
            
            // Инициализация групп
            Object.keys(specGroups).forEach(group => {
                groupPoints.phone1[group] = 0;
                groupPoints.phone2[group] = 0;
                scores.groupScores[group] = { phone1: 0, phone2: 0 };
            });
            
            // Счетчики характеристик в группах
            const groupCounts = {};
            
            // Проходим по всем группам характеристик
            Object.entries(specGroups).forEach(([groupName, specs]) => {
                groupCounts[groupName] = 0;
                
                specs.forEach(spec => {
                    const value1 = phone1[spec];
                    const value2 = phone2[spec];
                    
                    // Пропускаем если отсутствуют значения
                    if (!value1 && !value2) return;
                    
                    const norm1 = normalizeValue(spec, value1);
                    const norm2 = normalizeValue(spec, value2);
                    
                    // Пропускаем если не удалось нормализовать
                    if (typeof norm1 !== 'number' || typeof norm2 !== 'number') return;
                    
                    groupCounts[groupName]++;
                    
                    // Определяем правило сравнения
                    const rule = comparisonRules[spec] || { higherBetter: true };
                    const { higherBetter } = rule;
                    
                    // Рассчитываем баллы в зависимости от типа сравнения
                    if (higherBetter) {
                        if (norm1 > norm2) {
                            groupPoints.phone1[groupName] += 10;
                            groupPoints.phone2[groupName] += (norm2 / norm1) * 10;
                        } else if (norm2 > norm1) {
                            groupPoints.phone2[groupName] += 10;
                            groupPoints.phone1[groupName] += (norm1 / norm2) * 10;
                        } else {
                            groupPoints.phone1[groupName] += 10;
                            groupPoints.phone2[groupName] += 10;
                        }
                    } else {
                        if (norm1 < norm2) {
                            groupPoints.phone1[groupName] += 10;
                            groupPoints.phone2[groupName] += (norm1 / norm2) * 10;
                        } else if (norm2 < norm1) {
                            groupPoints.phone2[groupName] += 10;
                            groupPoints.phone1[groupName] += (norm2 / norm1) * 10;
                        } else {
                            groupPoints.phone1[groupName] += 10;
                            groupPoints.phone2[groupName] += 10;
                        }
                    }
                });
            });
            
            // Рассчитываем итоговые баллы с учетом весов
            Object.keys(groupPoints.phone1).forEach(group => {
                if (groupCounts[group] > 0) {
                    // Средний балл в группе
                    const avg1 = groupPoints.phone1[group] / groupCounts[group];
                    const avg2 = groupPoints.phone2[group] / groupCounts[group];
                    
                    // Применяем весовой коэффициент
                    const weight = groupWeights[group] || 0.05;
                    const weighted1 = avg1 * weight;
                    const weighted2 = avg2 * weight;
                    
                    scores.phone1 += weighted1;
                    scores.phone2 += weighted2;
                    
                    // Сохраняем для отображения
                    scores.groupScores[group] = {
                        phone1: Math.round(avg1),
                        phone2: Math.round(avg2)
                    };
                }
            });
            
            // Округляем общие баллы
            scores.phone1 = Math.round(scores.phone1 * 100);
            scores.phone2 = Math.round(scores.phone2 * 100);
            
            // Определяем победителя
            if (scores.phone1 > scores.phone2) {
                scores.winner = 1;
            } else if (scores.phone2 > scores.phone1) {
                scores.winner = 2;
            } else {
                scores.winner = 0; // Ничья
            }
            
            return scores;
        }

        // Функция для отображения результатов сравнения
        function displayComparisonResults(scores, phone1, phone2) {
            const brand1 = phone1.Бренд || phone1.Brand || 'Телефон 1';
            const model1 = phone1.Модель || phone1.Model || 'Неизвестно';
            const brand2 = phone2.Бренд || phone2.Brand || 'Телефон 2';
            const model2 = phone2.Модель || phone2.Model || 'Неизвестно';
            
            // Определяем классы для карточек
            const phone1Class = scores.winner === 1 ? 'winner-card' : (scores.winner === 0 ? 'draw-card' : 'loser-card');
            const phone2Class = scores.winner === 2 ? 'winner-card' : (scores.winner === 0 ? 'draw-card' : 'loser-card');
            
            // Создаем HTML для результатов
            let resultsHTML = `
                <div class="comparison-result">
                    <div class="winner-banner">
                        <h3>
                            ${scores.winner === 0 ? 
                                '<i class="fas fa-handshake me-2"></i> Ничья!' : 
                                `<i class="fas fa-trophy me-2"></i> Победитель: ${scores.winner === 1 ? brand1 + ' ' + model1 : brand2 + ' ' + model2}`
                            }
                        </h3>
                        <h4>Общий балл: ${scores.phone1} vs ${scores.phone2}</h4>
                    </div>
                    
                    <div class="score-summary">
                        <h4 class="text-center mb-4"><i class="fas fa-chart-bar me-2"></i>Результаты по категориям</h4>
                        <div class="grid-cols-2">
                            <div class="score-card ${phone1Class}">
                                <h4 class="text-center mb-3">${brand1} ${model1}</h4>
                                <div class="space-y-3">
            `;
            
            // Добавляем баллы по группам для первого телефона
            Object.entries(scores.groupScores).forEach(([group, groupScores]) => {
                if (groupScores.phone1 > 0 || groupScores.phone2 > 0) {
                    resultsHTML += `
                        <div class="spec-summary">
                            <div class="flex">
                                <span class="font-medium">${group}</span>
                                <span class="font-bold">${groupScores.phone1}/10</span>
                            </div>
                        </div>
                    `;
                }
            });
            
            resultsHTML += `
                                </div>
                            </div>
                            
                            <div class="score-card ${phone2Class}">
                                <h4 class="text-center mb-3">${brand2} ${model2}</h4>
                                <div class="space-y-3">
            `;
            
            // Добавляем баллы по группам для второго телефона
            Object.entries(scores.groupScores).forEach(([group, groupScores]) => {
                if (groupScores.phone1 > 0 || groupScores.phone2 > 0) {
                    resultsHTML += `
                        <div class="spec-summary">
                            <div class="flex">
                                <span class="font-medium">${group}</span>
                                <span class="font-bold">${groupScores.phone2}/10</span>
                            </div>
                        </div>
                    `;
                }
            });
            
            resultsHTML += `
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Создаем контейнер для результатов
            const resultsContainer = document.createElement('div');
            resultsContainer.id = 'comparisonResults';
            resultsContainer.innerHTML = resultsHTML;
            
            // Добавляем результаты в контейнер сравнения
            const compareContainer = document.getElementById('compareDetails');
            compareContainer.appendChild(resultsContainer);
        }

        // Элементы интерфейса
        const mainContent = document.getElementById('mainContent');
        const modeSwitcher = document.querySelector('.mode-switcher');
        const phoneSearch = document.getElementById('phoneSearch');
        const searchResults = document.getElementById('searchResults');
        const phoneDetails = document.getElementById('phoneDetails');
        const phoneTitle = document.getElementById('phoneTitle');
        const phoneImage = document.getElementById('phoneImage');
        const specsContainer = document.getElementById('specsContainer');
        const backToResults = document.getElementById('backToResults');
        
        // Режимы работы
        const singleModeBtn = document.getElementById('singleModeBtn');
        const compareModeBtn = document.getElementById('compareModeBtn');
        const compareSelection = document.getElementById('compareSelection');
        
        // Сравнение
        const compareDetails = document.getElementById('compareDetails');
        const backFromCompare = document.getElementById('backFromCompare');
        const startCompareBtn = document.getElementById('startCompareBtn');
        const clearCompareBtn = document.getElementById('clearCompareBtn');
        const selectPhoneBtns = document.querySelectorAll('.select-phone-btn');
        const phonePreviews = {
            1: document.getElementById('phonePreview1'),
            2: document.getElementById('phonePreview2')
        };
        const compareTitle1 = document.getElementById('compareTitle1');
        const compareTitle2 = document.getElementById('compareTitle2');
        const compareImage1 = document.getElementById('compareImage1');
        const compareImage2 = document.getElementById('compareImage2');
        const compareSpecs = document.getElementById('compareSpecs');
        
        // Текущий режим
        let currentMode = null;
        
        // Выбранные для сравнения телефоны
        let selectedPhones = {
            1: null,
            2: null
        };
        
        // Кэш данных телефонов
        let phoneCache = {};
        
        // Группы характеристик
        const specGroups = {
            "Основные": [
                "Год выпуска", "ОС", "Версия ОС", "Оболочка ОС", "Политика обновлений",
                "Последний патч безопасности"
            ],
            "Дисплей": [
                "Размер дисплея (дюймы)", "Разрешение дисплея", "Тип дисплея", 
                "Частота обновления (Гц)", "Пиковая яркость (нит)", "Поддержка HDR",
                "Защитное стекло", "Соотношение экран/корпус", "Плотность пикселей (PPI)"
            ],
            "Процессор": [
                "Процессор", "Архитектура CPU", "GPU", "Архитектура GPU", "NPU", "ISP", "Модем",
                "ОЗУ (ГБ)", "Тип ОЗУ", "Частота ОЗУ (МГц)", "ПЗУ (ГБ)", "Тип ПЗУ", "Скорость ПЗУ",
                "Система охлаждения", "Площадь охлаждения (мм²)", "Оценка AnTuTu", 
                "Geekbench (одиночное ядро)", "Geekbench (многоядерное)"
            ],
            "Камера": [
                "Основная камера (Мп)", "Сверхширокоугольная камера (Мп)", "Телефото 1 (Мп)", 
                "Телефото 2 (Мп)", "Фронтальная камера (Мп)", "Размер сенсора (основной)", 
                "Размер пикселя (основной)", "Возможности зума", "Видеозапись", "Замедленная съемка",
                "Функции камеры"
            ],
            "Батарея": [
                "Емкость батареи (mAh)", "Тип батареи", "Быстрая зарядка", "Беспроводная зарядка",
                "Обратная беспроводная зарядка", "Интерфейс зарядки", "Время работы от батареи (ч)",
                "Потребление в режиме ожидания", "Пиковая мощность"
            ],
            "Корпус": [
                "Вес (г)", "Габариты (мм)", "Материал корпуса", "Защита от воды", "Защита от пыли",
                "Сертификат защиты", "Материал рамки", "Материал задней панели", "Цвета"
            ],
            "Связь": [
                "Поддержка 5G", "Диапазоны 5G", "Поддержка mmWave", "Слоты SIM", "Тип SIM", 
                "Wi-Fi", "Особенности Wi-Fi", "Bluetooth", "Кодеки Bluetooth", "NFC", "ИК-порт", 
                "Версия USB", "GPS", "Спутниковая связь"
            ],
            "Аудио": [
                "Динамики", "Аудионастройка", "Микрофоны", "Аудиоразъем", "Пространственный звук"
            ],
            "Безопасность": [
                "Сканер отпечатков", "Разблокировка по лицу", "Акселерометр", "Гироскоп", 
                "Датчик приближения", "Компас", "Барометр", "Датчик освещенности", "Датчик Холла", 
                "LiDAR", "Термометр", "Датчик SpO2"
            ],
            "Дополнительно": [
                "Поддержка стилуса", "Тип стилуса", "Режим рабочего стола", "Поддержка VR", 
                "ИИ-функции", "Игровые функции", "Безопасный чип"
            ],
            "Комплектация": [
                "Зарядное устройство в комплекте", "Тип кабеля", "Адаптер в комплекте", 
                "Наушники в комплекте", "Чехол в комплекте"
            ],
            "Экология": [
                "Переработанные материалы", "Упаковка", "Экосертификаты", "Индекс ремонтопригодности",
                "Циклы батареи"
            ],
            "Безопасность (SAR)": [
                "SAR (голова)", "SAR (тело)"
            ],
            "Цена": [
                "Стартовая цена (руб)", "Текущая цена (руб)", "Доступность", "Гарантия (мес)"
            ]
        };
        
        // Переключение режимов - ИСПРАВЛЕННАЯ ВЕРСИЯ
        singleModeBtn.addEventListener('click', function() {
            setActiveMode('single');
        });
        
        compareModeBtn.addEventListener('click', function() {
            setActiveMode('compare');
        });
        
        function setActiveMode(mode) {
            // Если режим уже активен - сбрасываем его
            if (currentMode === mode) {
                resetMode();
                return;
            }
            
            // Устанавливаем новый режим
            currentMode = mode;
            
            // Обновляем кнопки
            singleModeBtn.classList.toggle('active', mode === 'single');
            compareModeBtn.classList.toggle('active', mode === 'compare');
            
            // Показываем основной контент
            mainContent.style.display = 'block';
            
            // Скрываем все подразделы
            compareSelection.style.display = 'none';
            searchResults.style.display = 'none';
            phoneDetails.style.display = 'none';
            compareDetails.style.display = 'none';
            
            // Показываем нужный раздел в зависимости от режима
            if (mode === 'compare') {
                compareSelection.style.display = 'block';
            } else if (mode === 'single') {
                searchResults.style.display = 'block';
                phoneSearch.focus();
            }
        }
        
        function resetMode() {
            currentMode = null;
            
            // Сбрасываем кнопки
            singleModeBtn.classList.remove('active');
            compareModeBtn.classList.remove('active');
            
            // Скрываем основной контент
            mainContent.style.display = 'none';
            
            // Сбрасываем выбранные телефоны
            selectedPhones = { 1: null, 2: null };
            phonePreviews[1].innerHTML = `
                <div class="placeholder">
                    <i class="fas fa-plus"></i>
                    <p>Выберите телефон</p>
                </div>
            `;
            phonePreviews[2].innerHTML = `
                <div class="placeholder">
                    <i class="fas fa-plus"></i>
                    <p>Выберите телефон</p>
                </div>
            `;
            startCompareBtn.disabled = true;
        }
        
        // Выбор телефона для сравнения
        selectPhoneBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const phoneNum = parseInt(this.getAttribute('data-phone'));
                openPhoneSelection(phoneNum);
            });
        });
        
        function openPhoneSelection(phoneNum) {
            // Сохраняем номер телефона, который выбираем
            sessionStorage.setItem('selectingFor', phoneNum);
            
            // Очищаем поисковый запрос
            phoneSearch.value = '';
            
            // Показываем результаты поиска
            searchResults.style.display = 'block';
            compareSelection.style.display = 'none';
            phoneDetails.style.display = 'none';
            compareDetails.style.display = 'none';
            
            // Очищаем предыдущие результаты
            document.querySelector('.phone-grid').innerHTML = '';
            
            // Фокусируемся на поле поиска
            phoneSearch.focus();
        }
        
        // Кнопка сравнения
        startCompareBtn.addEventListener('click', startComparison);
        
        // Очистка выбора
        clearCompareBtn.addEventListener('click', function() {
            selectedPhones = {
                1: null,
                2: null
            };
            
            // Очищаем превью
            phonePreviews[1].innerHTML = `
                <div class="placeholder">
                    <i class="fas fa-plus"></i>
                    <p>Выберите телефон</p>
                </div>
            `;
            
            phonePreviews[2].innerHTML = `
                <div class="placeholder">
                    <i class="fas fa-plus"></i>
                    <p>Выберите телефон</p>
                </div>
            `;
            
            // Блокируем кнопку сравнения
            startCompareBtn.disabled = true;
        });
        
        // Назад из режима сравнения
        backFromCompare.addEventListener('click', function() {
            compareDetails.style.display = 'none';
            compareSelection.style.display = 'block';
        });
        
        // Live-поиск с задержкой
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }
        
        phoneSearch.addEventListener('input', debounce(function() {
            const query = phoneSearch.value.trim();
            if (query.length > 1) {
                searchPhones(query);
            } else {
                document.querySelector('.phone-grid').innerHTML = '';
            }
        }, 300));
        
        // Функция поиска телефонов
        function searchPhones(query) {
            const phoneGrid = document.querySelector('.phone-grid');
            phoneGrid.innerHTML = '<div class="text-center py-5"><div class="spinner"></div><p>Идет поиск...</p></div>';
            
            fetch(`/compare/search?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    displaySearchResults(data);
                })
                .catch(error => {
                    phoneGrid.innerHTML = '<div class="text-center py-4">Ошибка при поиске</div>';
                    console.error('Error:', error);
                });
        }

        // Отображение результатов поиска
        function displaySearchResults(phones) {
            const phoneGrid = document.querySelector('.phone-grid');
            
            if (!phones || phones.length === 0) {
                phoneGrid.innerHTML = '<div class="text-center py-4">Телефоны не найдены</div>';
                return;
            }

            let html = '';
            phones.forEach(phone => {
                // Определяем бренд и модель с учетом языка
                const brand = phone.Бренд || phone.Brand || 'Неизвестный бренд';
                const model = phone.Модель || phone.Model || 'Неизвестная модель';
                
                // Формируем путь к изображению (с учетом новой структуры)
                const brandFolder = brand.replace(/\s+/g, '_').toLowerCase();
                const modelName = model.replace(/\s+/g, '_').toLowerCase();
                const imagePath = `/static/img/phones/${brandFolder}/${modelName}.jpg`;
                
                // Сохраняем в кэш
                phoneCache[phone._id] = phone;
                
                html += `
                    <div class="phone-card" data-id="${phone._id}">
                        <div class="text-center">
                            <img src="${imagePath}" alt="${brand} ${model}" 
                                 class="phone-thumb" onerror="this.src='/static/placeholder.jpg'">
                        </div>
                        <div class="card-body text-center mt-3">
                            <h5>${brand} ${model}</h5>
                            <p>${phone['Год выпуска'] || phone.Year || ''} • ${phone.ОС || phone.OS || ''}</p>
                            <button class="btn btn-primary view-details-btn">
                                <i class="fas fa-info-circle me-2"></i>${currentMode === 'single' ? 'Подробнее' : 'Выбрать'}
                            </button>
                        </div>
                    </div>
                `;
            });
            phoneGrid.innerHTML = html;

            // Добавляем обработчики событий
            document.querySelectorAll('.view-details-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const phoneId = this.closest('.phone-card').getAttribute('data-id');
                    
                    if (currentMode === 'single') {
                        loadPhoneDetails(phoneId);
                    } else {
                        selectPhoneForComparison(phoneId);
                    }
                });
            });
        }
        
        // Загрузка деталей телефона
        function loadPhoneDetails(phoneId) {
            if (phoneCache[phoneId]) {
                displayPhoneDetails(phoneCache[phoneId]);
            } else {
                fetch(`/compare/phone/${phoneId}`)
                    .then(response => response.json())
                    .then(phone => {
                        phoneCache[phoneId] = phone;
                        displayPhoneDetails(phone);
                    })
                    .catch(error => console.error('Ошибка:', error));
            }
        }
        
        // Отображение деталей телефона с группировкой
        function displayPhoneDetails(phone) {
            const brand = phone.Бренд || phone.Brand || 'Неизвестный бренд';
            const model = phone.Модель || phone.Model || 'Неизвестная модель';
            
            phoneTitle.textContent = `${brand} ${model}`;
            
            // Формируем путь к изображению (с учетом новой структуры)
            const brandFolder = brand.replace(/\s+/g, '_').toLowerCase();
            const modelName = model.replace(/\s+/g, '_').toLowerCase();
            phoneImage.src = `/static/img/phones/${brandFolder}/${modelName}.jpg`;
            phoneImage.onerror = function() { this.src = '/static/placeholder.jpg'; };
            
            let specsHTML = '';
            
            // Создаем группы характеристик
            for (const [groupName, groupSpecs] of Object.entries(specGroups)) {
                let groupHTML = '';
                
                for (const spec of groupSpecs) {
                    if (phone[spec]) {
                        groupHTML += `
                            <div class="spec-item">
                                <div class="spec-name">${spec}</div>
                                <div class="spec-value">${phone[spec]}</div>
                            </div>
                        `;
                    }
                }
                
                if (groupHTML) {
                    specsHTML += `
                        <div class="spec-group">
                            <div class="group-header">
                                <i class="fas fa-circle"></i>
                                <h4>${groupName}</h4>
                            </div>
                            <div class="spec-items">
                                ${groupHTML}
                            </div>
                        </div>
                    `;
                }
            }
            
            specsContainer.innerHTML = specsHTML;
            searchResults.style.display = 'none';
            phoneDetails.style.display = 'block';
        }
        
        // Выбор телефона для сравнения
        function selectPhoneForComparison(phoneId) {
            const phone = phoneCache[phoneId];
            if (!phone) return;
            
            const selectingFor = sessionStorage.getItem('selectingFor');
            if (!selectingFor) return;
            
            const phoneNum = parseInt(selectingFor);
            
            // Сохраняем выбранный телефон
            selectedPhones[phoneNum] = phoneId;
            
            // Обновляем превью
            const brand = phone.Бренд || phone.Brand || 'Неизвестный бренд';
            const model = phone.Модель || phone.Model || 'Неизвестная модель';
            
            // Формируем путь к изображению (с учетом новой структуры)
            const brandFolder = brand.replace(/\s+/g, '_').toLowerCase();
            const modelName = model.replace(/\s+/g, '_').toLowerCase();
            const imagePath = `/static/img/phones/${brandFolder}/${modelName}.jpg`;
            
            phonePreviews[phoneNum].innerHTML = `
                <div class="selected-phone">
                    <img src="${imagePath}" alt="${brand} ${model}" 
                         class="phone-thumb-sm" onerror="this.src='/static/placeholder.jpg'">
                    <div class="phone-info">
                        <strong>${brand} ${model}</strong>
                        <div>${phone['Год выпуска'] || phone.Year || ''}</div>
                    </div>
                    <button class="btn btn-sm btn-outline-danger remove-phone" data-phone="${phoneNum}">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            // Добавляем обработчик для кнопки удаления
            phonePreviews[phoneNum].querySelector('.remove-phone').addEventListener('click', function(e) {
                e.stopPropagation();
                const num = this.getAttribute('data-phone');
                selectedPhones[num] = null;
                phonePreviews[num].innerHTML = `
                    <div class="placeholder">
                        <i class="fas fa-plus"></i>
                        <p>Выберите телефон</p>
                    </div>
                `;
                checkCompareReadiness();
            });
            
            // Возвращаемся к выбору телефонов
            compareSelection.style.display = 'block';
            searchResults.style.display = 'none';
            
            // Проверяем готовность к сравнению
            checkCompareReadiness();
        }
        
        // Проверка готовности к сравнению
        function checkCompareReadiness() {
            startCompareBtn.disabled = !(selectedPhones[1] && selectedPhones[2]);
        }
        
        // Запуск сравнения
        function startComparison() {
            const phoneId1 = selectedPhones[1];
            const phoneId2 = selectedPhones[2];
            
            if (!phoneId1 || !phoneId2) return;
            
            const phone1 = phoneCache[phoneId1];
            const phone2 = phoneCache[phoneId2];
            
            if (!phone1 || !phone2) return;
            
            // Показываем контейнер сравнения
            compareSelection.style.display = 'none';
            compareDetails.style.display = 'block';
            
            // Удаляем предыдущие результаты, если есть
            const existingResults = document.getElementById('comparisonResults');
            if (existingResults) {
                existingResults.remove();
            }
            
            // Заполняем заголовки
            const brand1 = phone1.Бренд || phone1.Brand || 'Неизвестный бренд';
            const model1 = phone1.Модель || phone1.Model || 'Неизвестная модель';
            const brand2 = phone2.Бренд || phone2.Brand || 'Неизвестный бренд';
            const model2 = phone2.Модель || phone2.Model || 'Неизвестная модель';
            
            compareTitle1.textContent = `${brand1} ${model1}`;
            compareTitle2.textContent = `${brand2} ${model2}`;
            
            // Загружаем изображения
            const brandFolder1 = brand1.replace(/\s+/g, '_').toLowerCase();
            const modelName1 = model1.replace(/\s+/g, '_').toLowerCase();
            const imagePath1 = `/static/img/phones/${brandFolder1}/${modelName1}.jpg`;
            
            const brandFolder2 = brand2.replace(/\s+/g, '_').toLowerCase();
            const modelName2 = model2.replace(/\s+/g, '_').toLowerCase();
            const imagePath2 = `/static/img/phones/${brandFolder2}/${modelName2}.jpg`;
            
            compareImage1.src = imagePath1;
            compareImage2.src = imagePath2;
            
            compareImage1.onerror = function() { 
                this.src = '/static/placeholder.jpg';
            };
            
            compareImage2.onerror = function() { 
                this.src = '/static/placeholder.jpg';
            };
            
            // Генерируем таблицу сравнения
            generateComparisonGrid(phone1, phone2);
            
            // Рассчитываем баллы и выводим результаты
            const scores = compareSpecs(phone1, phone2);
            displayComparisonResults(scores, phone1, phone2);
        }
        
        // Генерация таблицы сравнения
        function generateComparisonGrid(phone1, phone2) {
            let html = '';
            
            // Исключаемые поля
            const excludeFields = ['_id', 'ID', 'Бренд', 'Brand', 'Модель', 'Model'];
            
            // Собираем все характеристики для группы "Другое"
            const otherSpecs = new Set();
            for (const key in phone1) {
                if (!excludeFields.includes(key) && phone1[key]) {
                    otherSpecs.add(key);
                }
            }
            for (const key in phone2) {
                if (!excludeFields.includes(key) && phone2[key]) {
                    otherSpecs.add(key);
                }
            }
            
            // Создаем группы характеристик
            for (const [groupName, groupSpecs] of Object.entries(specGroups)) {
                let groupHasSpec = false;
                let groupHTML = '';
                
                for (const spec of groupSpecs) {
                    if (otherSpecs.has(spec)) {
                        otherSpecs.delete(spec);
                        groupHasSpec = true;
                        
                        const value1 = phone1[spec] || '-';
                        const value2 = phone2[spec] || '-';
                        const diffClass1 = value1 !== value2 ? 'diff-value' : '';
                        const diffClass2 = value1 !== value2 ? 'diff-value' : '';
                        
                        groupHTML += `
                            <div class="compare-spec-name">${spec}</div>
                            <div class="compare-spec-value ${diffClass1}">${value1}</div>
                            <div class="compare-spec-value ${diffClass2}">${value2}</div>
                        `;
                    }
                }
                
                if (groupHasSpec) {
                    html += `
                        <div class="compare-spec-group">
                            <div class="compare-group-header">
                                <i class="fas fa-circle"></i>
                                <h4>${groupName}</h4>
                            </div>
                            <div class="compare-spec-items">
                                ${groupHTML}
                            </div>
                        </div>
                    `;
                }
            }
            
            // Добавляем группу "Другое"
            if (otherSpecs.size > 0) {
                let groupHTML = '';
                for (const spec of otherSpecs) {
                    const value1 = phone1[spec] || '-';
                    const value2 = phone2[spec] || '-';
                    const diffClass1 = value1 !== value2 ? 'diff-value' : '';
                    const diffClass2 = value1 !== value2 ? 'diff-value' : '';
                    
                    groupHTML += `
                        <div class="compare-spec-name">${spec}</div>
                        <div class="compare-spec-value ${diffClass1}">${value1}</div>
                        <div class="compare-spec-value ${diffClass2}">${value2}</div>
                    `;
                }
                
                html += `
                    <div class="compare-spec-group">
                        <div class="compare-group-header">
                            <i class="fas fa-circle"></i>
                            <h4>Другие характеристики</h4>
                        </div>
                        <div class="compare-spec-items">
                            ${groupHTML}
                        </div>
                    </div>
                `;
            }
            
            compareSpecs.innerHTML = html;
        }

        // Обработчик кнопки "Назад"
        backToResults.addEventListener('click', function() {
            phoneDetails.style.display = 'none';
            if (currentMode === 'single') {
                searchResults.style.display = 'block';
            } else {
                compareSelection.style.display = 'block';
            }
        });
    });
    </script>
</body>
</html>
