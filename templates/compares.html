<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>База спецификаций телефонов</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container mt-5">
        <div class="text-center mb-5">
            <h1 class="display-4 mb-3">База спецификаций телефонов</h1>
            <p class="lead">Найдите и изучите характеристики различных моделей смартфонов</p>
            
            <div class="form-group mt-4" style="max-width: 600px; margin: 0 auto;">
                <div class="input-group">
                    <input type="text" id="phoneSearch" class="form-control form-control-lg" 
                           placeholder="Введите бренд или модель телефона...">
                    <button id="searchBtn" class="btn btn-primary">
                        <i class="fas fa-search me-2"></i>Найти
                    </button>
                </div>
            </div>
        </div>

        <div id="searchResults" class="phone-grid">
            <!-- Результаты поиска будут здесь -->
        </div>

        <div id="phoneDetails" class="specs-container mt-5" style="display: none;">
            <button id="backToResults" class="btn btn-secondary mb-4">
                <i class="fas fa-arrow-left me-2"></i>Назад к результатам
            </button>
            
            <div class="specs-header">
                <div class="specs-phone">
                    <img id="phoneImage" src="" alt="Phone" class="phone-thumb">
                    <div id="phoneTitle" class="mt-3 h3 text-center"></div>
                </div>
            </div>
            
            <div class="spec-items mt-4" id="specsContainer">
                <!-- Спецификации будут здесь -->
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const phoneSearch = document.getElementById('phoneSearch');
        const searchBtn = document.getElementById('searchBtn');
        const searchResults = document.getElementById('searchResults');
        const phoneDetails = document.getElementById('phoneDetails');
        const phoneTitle = document.getElementById('phoneTitle');
        const phoneImage = document.getElementById('phoneImage');
        const specsContainer = document.getElementById('specsContainer');
        const backToResults = document.getElementById('backToResults');

        // Функция поиска телефонов
        function searchPhones() {
            const query = phoneSearch.value.trim();
            if (!query) {
                searchResults.innerHTML = '<div class="text-center py-4">Введите запрос для поиска</div>';
                return;
            }
            
            searchResults.innerHTML = '<div class="text-center py-5"><div class="spinner"></div><p>Идет поиск...</p></div>';
            
            fetch(`/compare/search?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    displaySearchResults(data);
                })
                .catch(error => {
                    searchResults.innerHTML = '<div class="text-center py-4">Ошибка при поиске</div>';
                    console.error('Error:', error);
                });
        }

        // Отображение результатов поиска
        function displaySearchResults(phones) {
            if (!phones || phones.length === 0) {
                searchResults.innerHTML = '<div class="text-center py-4">Телефоны не найдены</div>';
                return;
            }

            let html = '<div class="phone-grid">';
            phones.forEach(phone => {
                // Определяем бренд и модель с учетом языка
                const brand = phone.Бренд || phone.Brand || 'Неизвестный бренд';
                const model = phone.Модель || phone.Model || 'Неизвестная модель';
                
                // Формируем путь к изображению
                const imagePath = `/static/img/phones/${brand}/${model}.jpg`.replace(/\s+/g, '_');
                
                html += `
                    <div class="phone-card" data-id="${phone._id}">
                        <div class="text-center">
                            <img src="${imagePath}" alt="${brand} ${model}" 
                                 class="phone-thumb" onerror="this.src='/static/placeholder.jpg'">
                        </div>
                        <div class="card-body text-center mt-3">
                            <h5>${brand} ${model}</h5>
                            <p>${phone['Год выпуска'] || phone.Year || ''} • ${phone.ОС || phone.OS || ''}</p>
                            <button class="btn btn-primary view-details-btn">
                                <i class="fas fa-info-circle me-2"></i>Подробнее
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            searchResults.innerHTML = html;

            // Добавляем обработчики событий для просмотра деталей
            document.querySelectorAll('.view-details-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const phoneId = this.closest('.phone-card').getAttribute('data-id');
                    loadPhoneDetails(phoneId);
                });
            });
        }

        // Загрузка деталей телефона
        function loadPhoneDetails(phoneId) {
            searchResults.style.opacity = '0.5';
            searchResults.innerHTML = '<div class="text-center py-5"><div class="spinner"></div><p>Загрузка деталей...</p></div>';
            
            fetch(`/compare/details/${phoneId}`)
                .then(response => response.json())
                .then(phone => {
                    displayPhoneDetails(phone);
                })
                .catch(error => {
                    searchResults.innerHTML = '<div class="text-center py-4">Ошибка загрузки</div>';
                    console.error('Error:', error);
                });
        }

        // Отображение деталей телефона
        function displayPhoneDetails(phone) {
            // Определяем бренд и модель с учетом языка
            const brand = phone.Бренд || phone.Brand || 'Неизвестный бренд';
            const model = phone.Модель || phone.Model || 'Неизвестная модель';
            
            // Формируем путь к изображению
            const imagePath = `/static/img/phones/${brand}/${model}.jpg`.replace(/\s+/g, '_');
            
            // Устанавливаем заголовок и изображение
            phoneTitle.textContent = `${brand} ${model}`;
            phoneImage.src = imagePath;
            phoneImage.onerror = function() { 
                this.src = '/static/placeholder.jpg';
            };
            
            // Формируем спецификации
            let specsHtml = '';
            
            // Собираем все характеристики, исключая технические поля
            const excludeFields = ['_id', 'ID', 'Бренд', 'Brand', 'Модель', 'Model'];
            const allSpecs = [];
            
            for (const [key, value] of Object.entries(phone)) {
                if (!excludeFields.includes(key)) {
                    allSpecs.push({ name: key, value });
                }
            }
            
            // Группируем характеристики по категориям (можно расширить)
            const categories = {
                'Основные': ['Год', 'Year', 'ОС', 'OS', 'Оболочка', 'Политика', 'Последний'],
                'Дисплей': ['Дисплей', 'Display', 'Экран', 'Screen', 'Разрешение', 'Resolution', 'Яркость', 'Частота', 'HDR'],
                'Процессор': ['Процессор', 'Processor', 'CPU', 'GPU', 'Архитектура', 'NPU', 'ISP', 'Модем'],
                'Память': ['ОЗУ', 'RAM', 'ПЗУ', 'ROM', 'Память', 'Memory', 'Storage'],
                'Камера': ['Камера', 'Camera', 'Фото', 'Photo', 'Видео', 'Video', 'сенсор', 'пиксель', 'зум'],
                'Батарея': ['Батарея', 'Battery', 'зарядка', 'charge', 'мощность'],
                'Корпус': ['Корпус', 'Body', 'Вес', 'Weight', 'Габариты', 'Размеры', 'Материал', 'Защита'],
                'Связь': ['Связь', 'Network', 'SIM', 'СИМ', 'Wi-Fi', 'Bluetooth', 'NFC', 'GPS'],
                'Датчики': ['Датчик', 'Sensor', 'акселерометр', 'гироскоп', 'компас', 'барометр'],
                'Дополнительно': ['Особенности', 'Features', 'Функции', 'стилус', 'VR', 'ИИ', 'игр']
            };
            
            // Создаем группы
            for (const [category, keywords] of Object.entries(categories)) {
                let groupHtml = '';
                let hasData = false;
                
                for (const spec of allSpecs) {
                    // Проверяем, содержит ли название характеристики одно из ключевых слов
                    if (keywords.some(kw => spec.name.toLowerCase().includes(kw.toLowerCase()))) {
                        hasData = true;
                        groupHtml += `
                            <div class="spec-item">
                                <div class="spec-name">${spec.name}</div>
                                <div class="spec-value">${spec.value}</div>
                            </div>
                        `;
                    }
                }
                
                if (hasData) {
                    specsHtml += `
                        <div class="spec-group">
                            <div class="group-header">
                                <i class="fas fa-chevron-down me-2"></i>
                                <h4>${category}</h4>
                            </div>
                            <div class="spec-items">
                                ${groupHtml}
                            </div>
                        </div>
                    `;
                }
            }
            
            // Характеристики, не вошедшие ни в одну группу
            const remainingSpecs = allSpecs.filter(spec => {
                // Проверяем, не была ли характеристика уже добавлена
                return !Object.values(categories).flat().some(kw => 
                    spec.name.toLowerCase().includes(kw.toLowerCase())
                );
            });
            
            if (remainingSpecs.length > 0) {
                let groupHtml = '';
                remainingSpecs.forEach(spec => {
                    groupHtml += `
                        <div class="spec-item">
                            <div class="spec-name">${spec.name}</div>
                            <div class="spec-value">${spec.value}</div>
                        </div>
                    `;
                });
                
                specsHtml += `
                    <div class="spec-group">
                        <div class="group-header">
                            <i class="fas fa-chevron-down me-2"></i>
                            <h4>Другие характеристики</h4>
                        </div>
                        <div class="spec-items">
                            ${groupHtml}
                        </div>
                    </div>
                `;
            }
            
            specsContainer.innerHTML = specsHtml;
            phoneDetails.style.display = 'block';
            searchResults.style.display = 'none';
            
            // Инициализируем группы (все открыты)
            document.querySelectorAll('.spec-items').forEach(group => {
                group.style.display = 'grid';
            });
            
            // Добавляем функционал сворачивания/разворачивания групп
            document.querySelectorAll('.group-header').forEach(header => {
                header.addEventListener('click', function() {
                    const items = this.nextElementSibling;
                    const icon = this.querySelector('i');
                    
                    if (items.style.display === 'none') {
                        items.style.display = 'grid';
                        icon.classList.remove('fa-chevron-right');
                        icon.classList.add('fa-chevron-down');
                    } else {
                        items.style.display = 'none';
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-right');
                    }
                });
            });
        }

        // Обработчики событий для поиска
        searchBtn.addEventListener('click', searchPhones);
        phoneSearch.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') searchPhones();
        });
        
        // Обработчик кнопки "Назад"
        backToResults.addEventListener('click', function() {
            phoneDetails.style.display = 'none';
            searchResults.style.display = 'block';
            searchResults.style.opacity = '1';
            searchResults.innerHTML = '';
            phoneSearch.value = '';
        });
        
        // Инициализация: показываем сообщение при загрузке
        searchResults.innerHTML = '<div class="text-center py-4">Введите запрос для поиска телефона</div>';
    });
    </script>
</body>
  </html>
